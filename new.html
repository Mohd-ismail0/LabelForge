<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Editable Label Maker — EAN13 → A4 PDF (draggable/resizable)</title>

  <!-- Libraries -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- interact.js for drag/resize -->
  <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>

  <style>
    :root{
      --bg:#f3f6fb; --card:#fff; --accent:#2469f2; --muted:#6b7280;
    }
    body{font-family:Inter,system-ui,Arial,sans-serif; margin:14px; background:var(--bg); color:#111}
    .container{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:1fr 420px;gap:12px}
    .card{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 8px 24px rgba(20,20,40,0.06)}
    h1{font-size:18px;margin:0 0 6px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input, select, textarea, button{font-size:14px;padding:8px;border-radius:8px;border:1px solid #e2e8f0}
    button{background:var(--accent);color:#fff;border:none;cursor:pointer}
    .help{font-size:13px;color:#555;margin-top:6px}
    .controls-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:8px}
    .cols-list{max-height:200px;overflow:auto;border-radius:6px;padding:8px;border:1px dashed #e6eefb;background:#fff}
    .label-wrapper{background:#fff;padding:8px;border-radius:8px;border:1px solid #e6eefb}
    /* Label canvas */
    .label-canvas{
      position:relative;
      background:#fff;
      box-shadow:0 8px 22px rgba(10,10,30,0.06);
      overflow:hidden;
      border:1px solid #e6eefb;
    }
    .draggable{
      position:absolute;
      box-sizing:border-box;
      touch-action:none;
    }
    .resizer-handle{width:10px;height:10px;background:rgba(0,0,0,0.15);position:absolute;right:0;bottom:0;border-radius:2px;cursor:se-resize;display:block}
    .label-element{padding:2px}
    .element-selected{outline:2px dashed rgba(36,105,242,0.6)}
    .small-muted{font-size:12px;color:var(--muted)}
    .grid-two{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .bottom-row{display:flex;gap:8px;align-items:center;margin-top:10px}
    .inline-input{width:120px}
    .spaced{margin-top:10px}
    .badge{background:#eef2ff;color:#2469f2;padding:6px 8px;border-radius:8px;font-weight:600}
  </style>
</head>
<body>
  <h1>Editable Label Maker — Drag/Resize — EAN-13 → A4 PDF</h1>
  <p class="small-muted">Upload Excel/CSV/Google Sheets, select barcode column (EAN-13), pick columns to render, set a quantity column, then visually position/resize elements on the label. Adjust page margins/spacing and generate a tightly-packed A4 PDF. All local.</p>

  <!-- Text & Layout Configuration Section -->
  <div class="card" style="margin-bottom:12px">
    <h3 style="margin:0 0 8px">Text & Layout Configuration</h3>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div>
        <label>Static Text Editor</label>
        <textarea id="staticTextEditor" rows="4" style="width:100%;font-size:12px" placeholder="Enter your static text here, one line per text element..."></textarea>
        <div style="display:flex;gap:8px;margin-top:6px">
          <button id="applyStaticText" style="background:#059669">Apply to Label</button>
          <button id="resetStaticText" style="background:#6b7280">Reset to Default</button>
        </div>
      </div>
      <div>
        <label>Layout Actions</label>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="createFlexGroup" style="background:#7c3aed">Create Flex Group</button>
          <button id="ungroupElements" style="background:#dc2626">Ungroup Selected</button>
          <button id="saveLayout" style="background:#059669">Save Layout</button>
          <button id="loadLayout" style="background:#6b7280">Load Layout</button>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- LEFT: controls -->
    <div class="card">
      <label>Upload Excel / CSV file</label>
      <input id="fileInput" type="file" accept=".xlsx,.xls,.csv" />
      <label style="margin-top:8px">Or paste Google Sheets CSV export link</label>
      <input id="gsUrl" placeholder="https://.../export?format=csv&sheet=Sheet1" />
      <div class="controls-row">
        <button id="loadGs">Load CSV</button>
        <button id="clearFile" style="background:#f3f4f6;color:#111;border:1px solid #e6eefb">Clear</button>
      </div>

      <hr style="margin:12px 0">

      <label>Row selector (preview)</label>
      <select id="rowSelect"><option value="">(no file)</option></select>

      <label style="margin-top:8px">Barcode column (EAN-13)</label>
      <select id="barcodeSelect"><option>(choose)</option></select>
      <div id="barcodeNotice" class="small-muted spaced"></div>

      <hr style="margin:12px 0">

      <label>Select dynamic columns (render as <code>header: value</code>)</label>
      <div id="colsList" class="cols-list"></div>

      <label style="margin-top:8px">Quantity column (multiplies labels)</label>
      <select id="quantitySelect"><option value="">(none — default 1)</option></select>

      <hr style="margin:12px 0">

      <label>Upload logo (PNG/JPG) — will be placed top-right by default</label>
      <input id="logoInput" type="file" accept="image/*" />
      <div class="small-muted spaced">Logo appears as a draggable/resizable element, default anchored to the top-right with 10px gap.</div>

      <hr style="margin:12px 0">

      <label>Label size (print mm)</label>
      <div class="controls-row">
        <button class="sizeBtn" data-w="60" data-h="40">60×40</button>
        <button class="sizeBtn active" data-w="80" data-h="60" style="background:#1e293b">80×60</button>
        <button class="sizeBtn" data-w="100" data-h="80">100×80</button>
      </div>

      <label style="margin-top:10px">Page & packing options</label>
      <div class="grid-two">
        <div>
          <label class="small-muted">Page margin (mm)</label>
          <input id="pageMargin" class="inline-input" type="number" value="5" min="0" />
        </div>
        <div>
          <label class="small-muted">Label spacing (mm)</label>
          <input id="labelSpacing" class="inline-input" type="number" value="3" min="0" />
        </div>
      </div>
      <div style="margin-top:8px">
        <label class="small-muted">Tight packing</label>
        <div class="small-muted">If checked, PDF generation will pack labels tightly into A4 using the configured margins and spacing.</div>
        <div style="margin-top:6px">
          <input id="tightPacking" type="checkbox" checked/> <label for="tightPacking" class="small-muted">Enable tight packing</label>
        </div>
      </div>

      <hr style="margin:12px 0">

      <label>Editable static bilingual text (you can also edit on the canvas)</label>
      <textarea id="staticText" rows="6" style="width:100%"></textarea>

      <div style="margin-top:10px;display:flex;gap:8px">
        <button id="applyStatic" style="background:#0ea5a6">Apply to canvas</button>
        <button id="renderPreview">Render preview</button>
        <button id="generatePdf" style="background:#059669">Generate & Download A4 PDF</button>
      </div>

      <div class="spaced small-muted">Tip: click an element on the canvas to select it. Use drag handles to resize. Use the font-size controls in the right panel to change text size for the selected element.</div>
    </div>

    <!-- RIGHT: preview + element controls -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div><strong>Label Canvas (editable)</strong> <span class="small-muted"> — drag/resize elements</span></div>
        <div>
          <button id="resetLayout" style="background:#f3f4f6;color:#111;border:1px solid #e6eefb">Reset positions</button>
        </div>
      </div>

      <div id="labelArea" class="label-wrapper">
        <!-- label canvas will be sized in pixels based on mm -> px at screen DPI for editing -->
        <div id="labelCanvas" class="label-canvas" style="width:320px;height:240px;margin:10px auto">
          <!-- draggable/resizable elements inserted here -->
          <!-- default elements: static1 static2 dynamic container barcode logo -->
          <div id="el_static1" class="draggable label-element element-selected" data-type="static" style="left:10px;top:8px;width:220px;height:auto">
            <div contenteditable="true" style="font-weight:700;direction:rtl;font-size:14px">مستورد ومُسوّق بواسطة: شركة أدفيستا للتسويق المحدودة | advistaltd.com</div>
            <div contenteditable="true" style="font-size:12px">Imported and Marketed By: Advista Marketing Pvt Ltd | advistaltd.com</div>
            <span class="resizer-handle"></span>
          </div>

          <div id="el_logo" class="draggable label-element" data-type="logo" style="right:10px;top:10px;width:60px;height:60px">
            <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.03)">
              <img id="logoPreview" src="" alt="logo" style="max-width:100%;max-height:100%;display:none" />
              <span id="logoPlaceholder" class="small-muted">logo</span>
            </div>
            <span class="resizer-handle"></span>
          </div>

          <div id="el_dynamic" class="draggable label-element" data-type="dynamic" style="left:10px;top:70px;width:200px;height:auto">
            <div id="dynamicInner"> <!-- populated dynamically --> </div>
            <span class="resizer-handle"></span>
          </div>

          <div id="el_barcode" class="draggable label-element" data-type="barcode" style="left:10px;bottom:16px;width:200px;height:64px;">
            <canvas id="barcodeCanvas" style="width:100%;height:100%"></canvas>
            <span class="resizer-handle"></span>
          </div>

          <div id="el_composition" class="draggable label-element" data-type="static" style="left:10px;bottom:8px;width:220px;height:auto">
            <div contenteditable="true" style="font-weight:700">تركيبة الخامة: نايلون + سباندكس</div>
            <div contenteditable="true" style="font-size:12px">Material Composition: Nylon + Spandex</div>
            <span class="resizer-handle"></span>
          </div>
        </div>

        <!-- element inspector -->
        <div style="margin-top:10px;display:flex;justify-content:space-between;gap:8px">
          <div>
            <div class="small-muted">Selected element:</div>
            <div id="selectedName" style="font-weight:700;margin-top:4px">(click an element)</div>
          </div>
          <div>
            <label class="small-muted">Font size (px)</label>
            <input id="fontSizeInput" type="number" value="14" min="6" style="width:80px" />
          </div>
          <div>
            <label class="small-muted">Font Weight</label>
            <select id="fontWeightSelect">
              <option value="normal">Normal</option>
              <option value="bold">Bold</option>
              <option value="lighter">Lighter</option>
              <option value="bolder">Bolder</option>
            </select>
          </div>
          <div>
            <label class="small-muted">Text Align</label>
            <select id="alignSelect"><option value="left">Left</option><option value="center">Center</option><option value="right">Right</option></select>
          </div>
          <div>
            <label class="small-muted">Text Color</label>
            <input id="textColorInput" type="color" value="#000000" style="width:60px" />
          </div>
          <div>
            <label class="small-muted">Z order</label>
            <div style="display:flex;gap:6px;margin-top:6px">
              <button id="bringForward">Bring Forward</button>
              <button id="sendBack">Send Back</button>
            </div>
          </div>
        </div>

        <div class="spaced small-muted">You can also edit the static text directly by clicking the text on the canvas. Use the inspector to change font size and alignment for the selected element.</div>
      </div>
    </div>
  </div>

<script>
/* =============================
   Text & Layout Configuration System
   ============================= */

/* =============================
   Utils & state
   ============================= */
const screenDpi = window.devicePixelRatio * 96; // screen px per CSS inch approx
// convert mm to px for editing canvas sizing (for editing we use 96 DPI baseline)
function mmToPxScreen(mm){ return Math.round(mm * 96 / 25.4); }
// convert mm to px for printing/export (configurable DPI)
function mmToPxPrint(mm, dpi=300){ return Math.round(mm * dpi / 25.4); }

let parsedData = [];
let headers = [];
let labelSize = {w:80, h:60}; // mm default
let pageMarginMM = 5;
let labelSpacingMM = 3;
let tightPacking = true;
let currentLogoDataUrl = null;

/* DOM refs */
const fileInput = document.getElementById('fileInput');
const gsUrl = document.getElementById('gsUrl');
const loadGs = document.getElementById('loadGs');
const clearFile = document.getElementById('clearFile');
const rowSelect = document.getElementById('rowSelect');
const barcodeSelect = document.getElementById('barcodeSelect');
const barcodeNotice = document.getElementById('barcodeNotice');
const colsList = document.getElementById('colsList');
const quantitySelect = document.getElementById('quantitySelect');
const logoInput = document.getElementById('logoInput');
const logoPreview = document.getElementById('logoPreview');
const logoPlaceholder = document.getElementById('logoPlaceholder');
const labelCanvas = document.getElementById('labelCanvas');
const el_dynamic = document.getElementById('el_dynamic');
const el_barcode = document.getElementById('el_barcode');
const barcodeCanvas = document.getElementById('barcodeCanvas');
const el_static1 = document.getElementById('el_static1');
const el_composition = document.getElementById('el_composition');
const renderPreviewBtn = document.getElementById('renderPreview');
const generatePdfBtn = document.getElementById('generatePdf');
const staticTextArea = document.getElementById('staticText');
const applyStaticBtn = document.getElementById('applyStatic');
const pageMarginInput = document.getElementById('pageMargin');
const labelSpacingInput = document.getElementById('labelSpacing');
const tightPackingInput = document.getElementById('tightPacking');
const sizeButtons = document.querySelectorAll('.sizeBtn');
const rowSelector = rowSelect;
const selectedName = document.getElementById('selectedName');
const fontSizeInput = document.getElementById('fontSizeInput');
const alignSelect = document.getElementById('alignSelect');
const bringForwardBtn = document.getElementById('bringForward');
const sendBackBtn = document.getElementById('sendBack');
const resetLayoutBtn = document.getElementById('resetLayout');

// Text & Layout configuration DOM refs
const staticTextEditor = document.getElementById('staticTextEditor');
const applyStaticTextBtn = document.getElementById('applyStaticText');
const resetStaticTextBtn = document.getElementById('resetStaticText');
const createFlexGroupBtn = document.getElementById('createFlexGroup');
const ungroupElementsBtn = document.getElementById('ungroupElements');
const saveLayoutBtn = document.getElementById('saveLayout');
const loadLayoutBtn = document.getElementById('loadLayout');
const fontWeightSelect = document.getElementById('fontWeightSelect');
const textColorInput = document.getElementById('textColorInput');

/* set textarea default static */
const presetStatic = `مستورد ومُسوّق بواسطة: شركة أدفيستا للتسويق المحدودة | advistaltd.com
Imported and Marketed By: Advista Marketing Pvt Ltd | advistaltd.com

info@advistaltd.com | بنغالور، الهند
info@advistaltd.com | Bangalore, India

رقم ضريبة القيمة المضافة (VAT): 313061260900003

تركيبة الخامة: نايلون + سباندكس
Material Composition: Nylon + Spandex`;

staticTextArea.value = presetStatic;

/* =============================
   Parsing & sheet loading
   ============================= */
fileInput.addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const name = f.name.toLowerCase();
  if(name.endsWith('.csv')){
    const text = await f.text();
    parseCSV(text);
  } else {
    const data = await f.arrayBuffer();
    const wb = XLSX.read(data, {type:'array'});
    const first = wb.Sheets[wb.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(first, {defval:''});
    loadParsed(json);
  }
});

loadGs.addEventListener('click', async ()=>{
  const url = gsUrl.value.trim();
  if(!url){ alert('Paste Google Sheets CSV export URL'); return; }
  try{
    const res = await fetch(url);
    if(!res.ok) throw new Error('Fetch failed ' + res.status);
    const text = await res.text();
    parseCSV(text);
  }catch(err){
    alert('Failed to load CSV: ' + err.message);
  }
});

clearFile.addEventListener('click', ()=>{
  parsedData = []; headers = [];
  rowSelect.innerHTML = '<option>(no file)</option>';
  barcodeSelect.innerHTML = '<option>(choose)</option>';
  colsList.innerHTML = '';
  quantitySelect.innerHTML = '<option>(none)</option>';
  alert('Cleared file and UI selections.');
});

function parseCSV(text){
  try{
    const wb = XLSX.read(text, {type:'string'});
    const first = wb.Sheets[wb.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(first, {defval:''});
    loadParsed(json);
  }catch(e){
    alert('CSV parse error: ' + e.message);
  }
}

function loadParsed(json){
  parsedData = json;
  if(!parsedData || parsedData.length === 0){ alert('No rows found'); return; }
  headers = Object.keys(parsedData[0]);
  // fill row selector
  rowSelect.innerHTML = '';
  parsedData.forEach((row,i)=>{
    const opt = document.createElement('option'); opt.value = i;
    opt.textContent = `Row ${i+1} — ${headers.slice(0,3).map(h=>String(row[h]).slice(0,12)).join(' | ')}`;
    rowSelect.appendChild(opt);
  });
  // fill barcode & quantity selects
  barcodeSelect.innerHTML = '<option value="">(choose)</option>';
  quantitySelect.innerHTML = '<option value="">(none)</option>';
  headers.forEach(h=>{
    const o = document.createElement('option'); o.value = h; o.textContent = h;
    barcodeSelect.appendChild(o);
    quantitySelect.appendChild(o.cloneNode(true));
  });
  renderColumnsCheckboxes();
  rowSelect.value = 0;
  updatePreviewFromRow(0);
}

/* render columns checkboxes */
function renderColumnsCheckboxes(){
  colsList.innerHTML = '';
  headers.forEach(h=>{
    const div = document.createElement('div'); div.style.display='flex'; div.style.justifyContent='space-between'; div.style.marginBottom='6px';
    const left = document.createElement('div'); left.innerHTML = `<strong>${h}</strong><div style="font-size:12px;color:#666">renders as: <code>${h}: [value]</code></div>`;
    const cb = document.createElement('input'); cb.type='checkbox'; cb.dataset.col=h;
    cb.addEventListener('change', ()=>updatePreviewFromRow(rowSelect.value));
    div.appendChild(left); div.appendChild(cb); colsList.appendChild(div);
  });
}

/* when row changes, update dynamic values & barcode */
rowSelect.addEventListener('change', (e)=>{
  const idx = e.target.value; if(idx==='') return;
  updatePreviewFromRow(parseInt(idx,10));
});
barcodeSelect.addEventListener('change', ()=>updatePreviewFromRow(rowSelect.value));

function updatePreviewFromRow(index){
  if(!parsedData[index]) return;
  const row = parsedData[index];
  // populate dynamic inner HTML
  const selectedCols = Array.from(colsList.querySelectorAll('input[type=checkbox]:checked')).map(cb=>cb.dataset.col);
  const dynHtml = selectedCols.map(c=>`<div><strong>${escapeHtml(c)}:</strong> ${escapeHtml(String(row[c] ?? ''))}</div>`).join('');
  document.getElementById('dynamicInner').innerHTML = dynHtml || '<div class="small-muted">No columns selected</div>';

  // barcode notice & render
  const bcCol = barcodeSelect.value;
  if(bcCol){
    let raw = String(row[bcCol] ?? '').replace(/\D/g,'');
    barcodeNotice.textContent = `Check barcode (digits only): ${raw} — EAN-13 needs 12 or 13 digits.`;
    renderBarcodeCanvas(raw);
  } else {
    barcodeNotice.textContent = 'No barcode column selected.';
    clearBarcodeCanvas();
  }
}

/* render barcode into canvas */
function renderBarcodeCanvas(value){
  const raw = String(value ?? '').replace(/\D/g,'');
  const ctxCanvas = barcodeCanvas;
  ctxCanvas.width = ctxCanvas.clientWidth * window.devicePixelRatio;
  ctxCanvas.height = ctxCanvas.clientHeight * window.devicePixelRatio;
  ctxCanvas.style.width = '100%';
  ctxCanvas.style.height = '100%';
  try{
    if(raw.length < 12) { // show placeholder
      const ctx = ctxCanvas.getContext('2d');
      ctx.clearRect(0,0,ctxCanvas.width,ctxCanvas.height);
      ctx.fillStyle = '#f8fafc'; ctx.fillRect(0,0,ctxCanvas.width,ctxCanvas.height);
      ctx.fillStyle = '#6b7280'; ctx.font = `${14 * window.devicePixelRatio}px Arial`; ctx.fillText('EAN-13 (12/13 digits)', 8 * window.devicePixelRatio, 24 * window.devicePixelRatio);
      return;
    }
    JsBarcode(ctxCanvas, raw, {format:'ean13', displayValue:true, fontSize:12*window.devicePixelRatio, height:40*window.devicePixelRatio});
  }catch(err){
    const ctx = ctxCanvas.getContext('2d');
    ctx.clearRect(0,0,ctxCanvas.width,ctxCanvas.height);
    ctx.fillStyle = '#fff0f0'; ctx.fillRect(0,0,ctxCanvas.width,ctxCanvas.height);
    ctx.fillStyle = '#b02a37'; ctx.font = `${12 * window.devicePixelRatio}px Arial`; ctx.fillText('Barcode error', 8 * window.devicePixelRatio, 24 * window.devicePixelRatio);
  }
}
function clearBarcodeCanvas(){ const ctx = barcodeCanvas.getContext('2d'); ctx.clearRect(0,0,barcodeCanvas.width, barcodeCanvas.height); }

/* logo upload & preview */
logoInput.addEventListener('change', (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const reader = new FileReader();
  reader.onload = (ev)=>{
    currentLogoDataUrl = ev.target.result;
    logoPreview.src = currentLogoDataUrl; logoPreview.style.display = 'block'; logoPlaceholder.style.display = 'none';
  };
  reader.readAsDataURL(f);
});

/* apply static textarea to on-canvas elements */
applyStaticBtn.addEventListener('click', ()=>{
  const lines = staticTextArea.value.split('\n').map(s=>s.trim()).filter(Boolean);
  if(lines.length>=1){
    // split first pair into two lines for el_static1
    const first = lines[0] || '';
    const second = lines[1] || '';
    const nodes = el_static1.querySelectorAll('div[contenteditable]');
    if(nodes.length>=1) nodes[0].textContent = first;
    if(nodes.length>=2) nodes[1].textContent = second;
  }
  // presumably lines 3/4 to composition or other element
  if(lines.length>=3){
    const third = lines[2] || '';
    const fourth = lines[3] || '';
    const compNodes = el_composition.querySelectorAll('div[contenteditable]');
    if(compNodes.length>=1) compNodes[0].textContent = third;
    if(compNodes.length>=2) compNodes[1].textContent = fourth;
  }
  updatePreviewFromRow(rowSelect.value);
});

/* size buttons for label size (editing canvas) */
sizeButtons.forEach(b=>{
  b.addEventListener('click', (ev)=>{
    sizeButtons.forEach(x=>x.style.filter=''); b.style.filter='brightness(0.9)';
    const w = parseFloat(b.dataset.w), h = parseFloat(b.dataset.h);
    labelSize = {w,h};
    // update canvas size in px for editing (use 96dpi baseline)
    const cssW = mmToPxScreen(w); const cssH = mmToPxScreen(h);
    labelCanvas.style.width = cssW + 'px'; labelCanvas.style.height = cssH + 'px';
  });
});
// initialize
document.querySelector('.sizeBtn[data-w="80"]').click();

/* =============================
   Drag & resize using interact.js
   ============================= */
/* helper to get/set element x,y,w,h relative to canvas (in px) */
function setElementRect(el, x, y, w, h){
  el.style.left = (x) + 'px';
  el.style.top = (y) + 'px';
  el.style.width = w + 'px';
  el.style.height = h + 'px';
  el.dataset.x = x; el.dataset.y = y; el.dataset.w = w; el.dataset.h = h;
}
function getElementRect(el){
  const x = parseFloat(el.dataset.x || parseFloat(el.style.left || 0));
  const y = parseFloat(el.dataset.y || parseFloat(el.style.top || 0));
  const w = parseFloat(el.dataset.w || parseFloat(el.style.width || el.offsetWidth));
  const h = parseFloat(el.dataset.h || parseFloat(el.style.height || el.offsetHeight));
  return {x,y,w,h};
}

/* initialize positions (if no dataset pos present) */
function resetDefaultPositions(){
  const canvasRect = labelCanvas.getBoundingClientRect();
  const cw = canvasRect.width, ch = canvasRect.height;
  setElementRect(el_static1, 10, 8, cw - 90, 60);
  setElementRect(el_logo, cw - 70, 10, 60, 60);
  setElementRect(el_dynamic, 10, 70, cw - 100, 70);
  setElementRect(el_barcode, 10, ch - 100, cw - 20, 80);
  setElementRect(el_composition, 10, ch - 40, cw - 100, 36);
}
resetDefaultPositions();

let selectedElement = null;
function selectElement(el){
  // remove selected class from others
  Array.from(labelCanvas.querySelectorAll('.draggable')).forEach(d=>d.classList.remove('element-selected'));
  if(!el) {
    selectedElement = null;
    selectedName.textContent = '(none)';
    return;
  }
  el.classList.add('element-selected');
  selectedElement = el;
  selectedName.textContent = (el.id || el.dataset.type || 'element');
  // if element has text, update inspector font-size & align fields
  const firstEditable = el.querySelector('[contenteditable]');
  if(firstEditable){
    const fs = window.getComputedStyle(firstEditable).fontSize.replace('px','');
    fontSizeInput.value = Math.round(parseFloat(fs) || 14);
    alignSelect.value = window.getComputedStyle(firstEditable).textAlign || 'left';
  } else {
    fontSizeInput.value = 14;
    alignSelect.value = 'left';
  }
}
labelCanvas.addEventListener('click', (e)=>{
  // find draggable ancestor
  const el = e.target.closest('.draggable');
  if(el && labelCanvas.contains(el)){
    selectElement(el);
    e.stopPropagation();
  } else {
    // clicked blank area
    selectElement(null);
  }
});
document.addEventListener('keydown', (e)=>{
  if(e.key === 'Delete' && selectedElement){
    // If it's contenteditable static, just clear text; else do nothing
    // We'll not allow full deletion to avoid accidentally losing elements.
    const t = selectedElement.querySelector('[contenteditable]');
    if(t) t.textContent = '';
  }
});

/* interact draggable/resizable setup */
interact('.draggable')
  .draggable({
    listeners: {
      start(event){},
      move(event){
        const target = event.target;
        const dx = event.dx, dy = event.dy;
        const x = (parseFloat(target.dataset.x) || parseFloat(target.style.left || 0)) + dx;
        const y = (parseFloat(target.dataset.y) || parseFloat(target.style.top || 0)) + dy;
        target.style.left = x + 'px'; target.style.top = y + 'px';
        target.dataset.x = x; target.dataset.y = y;
      },
      end(event){}
    },
    modifiers: [ interact.modifiers.restrictRect({ restriction: 'parent', endOnly: true }) ],
    inertia:true
  })
  .resizable({
    edges: { bottom: true, right: true },
    listeners: {
      move(event){
        const target = event.target;
        let x = parseFloat(target.dataset.x) || parseFloat(target.style.left || 0);
        let y = parseFloat(target.dataset.y) || parseFloat(target.style.top || 0);
        // update size
        let w = (parseFloat(target.dataset.w) || target.offsetWidth) + event.deltaRect.width;
        let h = (parseFloat(target.dataset.h) || target.offsetHeight) + event.deltaRect.height;
        // set minimums
        w = Math.max(w, 30); h = Math.max(h, 20);
        target.style.width = w + 'px'; target.style.height = h + 'px';
        // translate when edges change position
        x += event.deltaRect.left; y += event.deltaRect.top;
        target.style.left = x + 'px'; target.style.top = y + 'px';
        target.dataset.x = x; target.dataset.y = y; target.dataset.w = w; target.dataset.h = h;
      }
    },
    modifiers: [ interact.modifiers.restrictSize({ min: { width: 30, height: 20 } }), interact.modifiers.restrictEdges({ outer: 'parent' }) ],
    inertia:true
  });

/* inspector controls */
fontSizeInput.addEventListener('input', ()=>{
  if(!selectedElement) return;
  const txt = selectedElement.querySelector('[contenteditable]');
  if(txt) txt.style.fontSize = fontSizeInput.value + 'px';
});
alignSelect.addEventListener('change', ()=>{
  if(!selectedElement) return;
  const txt = selectedElement.querySelector('[contenteditable]');
  if(txt) txt.style.textAlign = alignSelect.value;
});
bringForwardBtn.addEventListener('click', ()=>{
  if(!selectedElement) return;
  selectedElement.parentNode.appendChild(selectedElement); // move to end -> top of z-order
});
sendBackBtn.addEventListener('click', ()=>{
  if(!selectedElement) return;
  selectedElement.parentNode.insertBefore(selectedElement, selectedElement.parentNode.firstChild); // send to back
});
resetLayoutBtn.addEventListener('click', ()=>{ resetDefaultPositions(); });

/* =============================
   PDF generation — tight packing & download
   ============================= */
generatePdfBtn.addEventListener('click', async ()=>{
  if(!parsedData || parsedData.length === 0){ alert('Load a sheet first'); return; }
  // collect config
  pageMarginMM = Math.max(0, parseFloat(pageMarginInput.value) || 5);
  labelSpacingMM = Math.max(0, parseFloat(labelSpacingInput.value) || 3);
  tightPacking = tightPackingInput.checked;

  // selected columns and quantity
  const selectedCols = Array.from(colsList.querySelectorAll('input[type=checkbox]:checked')).map(cb=>cb.dataset.col);
  const qtyCol = document.getElementById('quantitySelect').value;
  const bcCol = barcodeSelect.value;

  // assemble flat items list based on quantities
  const items = [];
  parsedData.forEach((row, idx)=>{
    let q = 1;
    if(qtyCol){
      const raw = String(row[qtyCol] ?? '').trim();
      const n = parseInt(raw,10);
      q = Number.isFinite(n) && n>0 ? n : 1;
    }
    for(let k=0;k<q;k++) items.push({row, rowIndex: idx});
  });
  if(items.length === 0){ alert('No labels generated (0 items).'); return; }

  // compute packing on A4
  const A4mm = {w:210, h:297};
  const usableW = A4mm.w - 2*pageMarginMM;
  const usableH = A4mm.h - 2*pageMarginMM;
  const colsPerPage = Math.floor( (usableW + labelSpacingMM) / (labelSize.w + labelSpacingMM) );
  const rowsPerPage = Math.floor( (usableH + labelSpacingMM) / (labelSize.h + labelSpacingMM) );
  if(colsPerPage < 1 || rowsPerPage < 1){ alert('Label size too large for A4 with current margins. Reduce label size or margins.'); return; }
  const perPage = colsPerPage * rowsPerPage;
  const pagesNeeded = Math.ceil(items.length / perPage);
  if(!confirm(`Will generate ${items.length} labels → ${pagesNeeded} A4 page(s) (${perPage} per page: ${colsPerPage}×${rowsPerPage}). Proceed?`)) return;

  // For each item, render high-res label (300 DPI) using html2canvas of a constructed DOM that mimics current positions & sizes
  const labelDPI = 300;
  const pxW = mmToPxPrint(labelSize.w, labelDPI);
  const pxH = mmToPxPrint(labelSize.h, labelDPI);

  // We will render each distinct row label once per instance (respect qty) — sequentially to avoid memory blowup
  // Show simple progress using document.title
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({unit:'mm', format:'a4', compress:true});

  // Precompute positions as fractions relative to editing canvas (so we can scale)
  const canvasRect = labelCanvas.getBoundingClientRect();
  const canvasW = canvasRect.width, canvasH = canvasRect.height;

  // helper to produce a DOM for a single label from a row
  async function renderOneLabel(row){
    // create offscreen wrapper sized pxW x pxH
    const wrapper = document.createElement('div');
    wrapper.style.width = pxW + 'px'; wrapper.style.height = pxH + 'px';
    wrapper.style.boxSizing = 'border-box'; wrapper.style.padding = '0'; wrapper.style.background = '#fff';
    wrapper.style.position = 'fixed'; wrapper.style.left = '-99999px'; wrapper.style.top = '-99999px';
    document.body.appendChild(wrapper);

    // replicate elements: we'll map each on-canvas element's dataset x/y/w/h (CSS px) to print px
    const elems = Array.from(labelCanvas.querySelectorAll('.draggable'));
    elems.forEach(el => {
      const rect = getElementRect(el); // returns px relative to editing canvas
      // convert to fraction of editing canvas, then to print px
      const fx = rect.x / canvasW;
      const fy = rect.y / canvasH;
      const fw = rect.w / canvasW;
      const fh = rect.h / canvasH;
      const printX = Math.round(fx * pxW);
      const printY = Math.round(fy * pxH);
      const printW = Math.max(2, Math.round(fw * pxW));
      const printH = Math.max(2, Math.round(fh * pxH));
      // create element depending on type
      const type = el.dataset.type || 'static';
      const elDom = document.createElement('div');
      elDom.style.position = 'absolute';
      elDom.style.left = printX + 'px';
      elDom.style.top = printY + 'px';
      elDom.style.width = printW + 'px';
      elDom.style.height = printH + 'px';
      elDom.style.overflow = 'hidden';
      elDom.style.boxSizing = 'border-box';
      // copy inner content (text/html)
      if(type === 'logo'){
        const img = document.createElement('img');
        if(currentLogoDataUrl){
          img.src = currentLogoDataUrl;
        } else {
          // small placeholder with text
          img.style.background = '#f3f4f6'; img.style.width = '100%'; img.style.height = '100%';
          img.alt = 'logo';
        }
        img.style.maxWidth = '100%'; img.style.maxHeight = '100%'; img.style.display = 'block';
        elDom.appendChild(img);
      } else if(type === 'barcode'){
        // create a canvas sized accordingly and render barcode
        const bCan = document.createElement('canvas');
        bCan.width = printW * window.devicePixelRatio;
        bCan.height = printH * window.devicePixelRatio;
        // attempt to get barcode value from row using selected barcode column
        const rawVal = (row[barcodeSelect.value] ?? '') + '';
        const digits = rawVal.replace(/\D/g,'');
        try{
          JsBarcode(bCan, digits, {format:'ean13', displayValue:true, fontSize:12*window.devicePixelRatio, height:(printH*0.5)*window.devicePixelRatio, margin:4*window.devicePixelRatio});
        }catch(e){
          const ctx = bCan.getContext('2d'); ctx.fillStyle='#fff0f0'; ctx.fillRect(0,0,bCan.width,bCan.height);
        }
        // scale down for HTML display/printing capture: make image element from canvas
        const dataUrl = bCan.toDataURL('image/png');
        const img = document.createElement('img'); img.src = dataUrl; img.style.width='100%'; img.style.height='100%';
        elDom.appendChild(img);
      } else {
        // static or dynamic text: we need to copy contenteditable text and dynamic values
        // find corresponding element inside el
        const source = el;
        const inner = source.querySelector('[contenteditable]') ? source.innerHTML : source.innerHTML;
        // For dynamic container, we must replace values with actual row data based on selected columns
        if(source.id === 'el_dynamic'){
          // produce HTML from selected columns
          const selectedCols = Array.from(colsList.querySelectorAll('input[type=checkbox]:checked')).map(cb=>cb.dataset.col);
          const dynHtml = selectedCols.map(c=>`<div style="font-size: ${12 * window.devicePixelRatio}px;"><strong>${escapeHtml(c)}:</strong> ${escapeHtml(String(row[c] ?? ''))}</div>`).join('');
          elDom.innerHTML = dynHtml;
        } else {
          // static element: copy text nodes
          // copy children (but scale font sizes by devicePixelRatio)
          const clone = source.cloneNode(true);
          // remove resizer handle if present
          const handle = clone.querySelector('.resizer-handle'); if(handle) handle.remove();
          // transform contenteditable children: scale font sizes
          clone.querySelectorAll('[contenteditable]').forEach(node=>{
            const computed = window.getComputedStyle(node);
            const fs = parseFloat(computed.fontSize) || 12;
            node.style.fontSize = Math.round(fs * (window.devicePixelRatio)) + 'px';
            node.style.margin = '0';
          });
          elDom.appendChild(clone);
        }
      }
      wrapper.appendChild(elDom);
    });

    // now capture wrapper via html2canvas at scale=1 (we already sized wrapper to print px)
    const canvas = await html2canvas(wrapper, {width: pxW, height: pxH, scale:1, backgroundColor:'#ffffff', useCORS:true});
    const dataUrl = canvas.toDataURL('image/png', 1.0);
    wrapper.remove();
    return dataUrl;
  } // end renderOneLabel

  // sequential rendering + adding to PDF pages
  let index = 0;
  let pageNum = 0;
  while(index < items.length){
    // new page
    if(pageNum > 0) pdf.addPage();
    // place labels grid on page
    for(let r=0;r<rowsPerPage;r++){
      for(let c=0;c<colsPerPage;c++){
        const globalIdx = pageNum * perPage + r*colsPerPage + c;
        if(globalIdx >= items.length) break;
        // generate image
        document.title = `Rendering ${globalIdx+1}/${items.length}...`;
        const dataUrl = await renderOneLabel(items[globalIdx].row);
        // compute x,y in mm
        const x = pageMarginMM + c * (labelSize.w + labelSpacingMM);
        const y = pageMarginMM + r * (labelSize.h + labelSpacingMM);
        pdf.addImage(dataUrl, 'PNG', x, y, labelSize.w, labelSize.h);
        index++;
      }
      if(index >= items.length) break;
    }
    pageNum++;
  }
  document.title = 'Label Maker';
  // trigger download
  pdf.save('labels_a4_tight.pdf');
  alert(`PDF generated: ${pageNum} page(s). Download should start automatically.`);
});

/* =============================
   Misc helpers & UI bindings
   ============================= */
function escapeHtml(s){
  if(!s) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

/* render preview button just updates barcode and dynamic text using current row */
renderPreviewBtn.addEventListener('click', ()=> updatePreviewFromRow(rowSelect.value) );

function getElementRect(el){
  // returns px relative to labelCanvas
  const left = parseFloat(el.style.left || el.dataset.x || 0);
  const top = parseFloat(el.style.top || el.dataset.y || 0);
  const w = parseFloat(el.style.width || el.dataset.w || el.offsetWidth);
  const h = parseFloat(el.style.height || el.dataset.h || el.offsetHeight);
  return {x:left, y:top, w:w, h:h};
}

/* when dynamic checkboxes change update preview */
colsList.addEventListener('change', ()=> updatePreviewFromRow(rowSelect.value) );

/* small helper: when clicking inside contenteditable update inspector */
labelCanvas.addEventListener('focusin', (e)=>{
  const el = e.target.closest('.draggable');
  if(el) selectElement(el);
}, true);

/* initialize minimal UI state */
updatePreviewFromRow(0);

/* =============================
   Text & Layout Configuration Functions
   ============================= */
function applyStaticTextFromEditor() {
  const editorText = staticTextEditor.value.trim();
  if (!editorText) {
    alert('Please enter some text in the editor first.');
    return;
  }
  
  staticTextArea.value = editorText;
  applyStaticBtn.click();
  alert('Static text applied to label successfully!');
}

function resetStaticTextToDefault() {
  staticTextEditor.value = presetStatic;
  staticTextArea.value = presetStatic;
  applyStaticBtn.click();
  alert('Static text reset to default.');
}

function createFlexGroup() {
  const selectedElements = getSelectedElements();
  if (selectedElements.length < 2) {
    alert('Please select at least 2 elements to group. Click on elements to select them.');
    return;
  }
  
  // Create a new flex container
  const flexContainer = document.createElement('div');
  flexContainer.className = 'flex-container';
  flexContainer.style.display = 'flex';
  flexContainer.style.gap = '8px';
  flexContainer.dataset.flexGroup = 'true';
  
  // Get the parent of the first selected element
  const parent = selectedElements[0].parentNode;
  
  // Insert the flex container before the first selected element
  parent.insertBefore(flexContainer, selectedElements[0]);
  
  // Move all selected elements into the flex container
  selectedElements.forEach(el => {
    flexContainer.appendChild(el);
  });
  
  alert(`Created flex group with ${selectedElements.length} elements.`);
}

function ungroupElements() {
  const selectedElements = getSelectedElements();
  const flexContainers = selectedElements.filter(el => el.dataset.flexGroup === 'true');
  
  if (flexContainers.length === 0) {
    alert('Please select a flex group to ungroup.');
    return;
  }
  
  flexContainers.forEach(container => {
    const parent = container.parentNode;
    const children = Array.from(container.children);
    
    // Move children back to parent
    children.forEach(child => {
      parent.insertBefore(child, container);
    });
    
    // Remove the flex container
    parent.removeChild(container);
  });
  
  alert(`Ungrouped ${flexContainers.length} flex container(s).`);
}

function getSelectedElements() {
  // Return all draggable elements for now - in a real implementation, you'd track selection
  return Array.from(document.querySelectorAll('.draggable'));
}

function saveLayout() {
  const layoutName = prompt('Enter a name for your layout configuration:');
  if (!layoutName) return;
  
  const layoutConfig = {
    name: layoutName,
    staticText: staticTextArea.value,
    timestamp: new Date().toISOString()
  };
  
  // Save to localStorage
  const savedLayouts = JSON.parse(localStorage.getItem('savedLayouts') || '{}');
  savedLayouts[layoutName.toLowerCase().replace(/\s+/g, '_')] = layoutConfig;
  localStorage.setItem('savedLayouts', JSON.stringify(savedLayouts));
  
  alert(`Layout configuration "${layoutName}" saved successfully!`);
}

function loadLayout() {
  const savedLayouts = JSON.parse(localStorage.getItem('savedLayouts') || '{}');
  const layoutNames = Object.keys(savedLayouts);
  
  if (layoutNames.length === 0) {
    alert('No saved layout configurations found. Save a layout first using "Save Layout".');
    return;
  }
  
  const layoutList = layoutNames.map((key, index) => `${index + 1}. ${savedLayouts[key].name}`).join('\n');
  const choice = prompt(`Select a layout to load (enter number):\n\n${layoutList}`);
  
  if (!choice) return;
  
  const index = parseInt(choice) - 1;
  if (index < 0 || index >= layoutNames.length) {
    alert('Invalid selection');
    return;
  }
  
  const selectedKey = layoutNames[index];
  const selectedLayout = savedLayouts[selectedKey];
  
  // Apply layout settings
  staticTextArea.value = selectedLayout.staticText;
  staticTextEditor.value = selectedLayout.staticText;
  applyStaticBtn.click();
  
  alert(`Loaded layout configuration: ${selectedLayout.name}`);
}

// Event handlers for new controls
applyStaticTextBtn.addEventListener('click', applyStaticTextFromEditor);
resetStaticTextBtn.addEventListener('click', resetStaticTextToDefault);
createFlexGroupBtn.addEventListener('click', createFlexGroup);
ungroupElementsBtn.addEventListener('click', ungroupElements);
saveLayoutBtn.addEventListener('click', saveLayout);
loadLayoutBtn.addEventListener('click', loadLayout);

// Enhanced styling controls
fontWeightSelect.addEventListener('change', ()=>{
  if(!selectedElement) return;
  const txt = selectedElement.querySelector('[contenteditable]');
  if(txt) txt.style.fontWeight = fontWeightSelect.value;
});

textColorInput.addEventListener('change', ()=>{
  if(!selectedElement) return;
  const txt = selectedElement.querySelector('[contenteditable]');
  if(txt) txt.style.color = textColorInput.value;
});

// Initialize static text editor with current value
staticTextEditor.value = staticTextArea.value;

</script>
</body>
</html>
