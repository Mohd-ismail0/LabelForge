<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Label Maker — EAN13 + PDF</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='28' fill='%232c7be5'/%3E%3Ctext x='32' y='38' font-size='28' text-anchor='middle' fill='white' font-family='Arial'%3EL%3C/text%3E%3C/svg%3E" />

  <!-- SheetJS (xlsx) -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <!-- JsBarcode for EAN13 -->
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <!-- html2canvas for rendering label to canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <!-- jsPDF for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- JSZip for ZIP downloads -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <style>
    :root{--accent:#2c7be5;--muted:#666;}
    body{font-family:Arial, Helvetica, sans-serif;background:#f2f5fb;margin:0;padding:18px;color:#111}
    .container{max-width:1200px;margin:0 auto}
    h1{font-size:20px;margin:0 0 8px}
    .card{background:#fff;padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(20,20,40,0.06)}
    .grid{display:grid;grid-template-columns:1fr 420px;gap:12px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input, select, textarea, button{font-size:14px;padding:8px;border-radius:8px;border:1px solid #d6dbe8}
    button{cursor:pointer;background:var(--accent);color:#fff;border:none}
    .cols-list{max-height:200px;overflow:auto;border:1px dashed #d6dbe8;padding:8px;border-radius:6px}
    .label-preview{background:#fff;padding:10px;border-radius:8px;border:1px solid #e6eefb;min-height:200px;display:flex;flex-direction:column}
    .logo-box{position:relative}
    .logo-topright{position:absolute;right:10px;top:10px;max-width:60px;max-height:60px;padding:0}
    .pair{background:#f3f6fb;padding:6px;border-radius:5px;margin-bottom:6px}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    small{color:var(--muted)}
    .help{font-size:13px;color:#555;margin-top:6px}
  </style>
</head>
<body>
  <div class="container">
    <h1>Label Maker — EAN13 + PDF (Excel/CSV/Google Sheets)</h1>
    <p class="help">Upload sheet, choose barcode column (EAN13), choose dynamic columns, pick a quantity column to multiply labels, select label size, choose paper size (A4/Letter/4"×6"/Custom), upload logo (will be rendered top-right with 10px padding), then "Generate PDF".</p>

    <div class="grid" style="margin-top:12px">
      <div class="card">
        <label>Upload Excel / CSV file</label>
        <input id="fileInput" type="file" accept=".xlsx,.xls,.csv" />
        <label style="margin-top:8px">Or paste Google Sheets CSV URL</label>
        <input id="gsUrl" type="text" placeholder="https://docs.google.com/spreadsheets/d/.../export?format=csv&sheet=Sheet1" />
        <div style="margin-top:8px;display:flex;gap:8px">
          <button id="loadGs">Load Google Sheets CSV</button>
          <button id="clearFile" style="background:#ddd;color:#111">Clear</button>
        </div>

        <hr style="margin:12px 0">

        <label>Choose row for preview</label>
        <select id="rowSelect"><option value="">(no file)</option></select>

        <label style="margin-top:8px">Barcode column (EAN-13)</label>
        <select id="barcodeSelect"><option value="">(choose column)</option></select>
        <div id="barcodeNotice" style="margin-top:8px;display:none;background:#fff7e6;padding:8px;border-radius:6px;border:1px solid #ffe8b3"></div>

        <hr style="margin:12px 0">

        <label>Select dynamic columns to render (header: value)</label>
        <div class="cols-list" id="colsList"></div>

        <label style="margin-top:8px">Quantity column (optional) — numeric column that multiplies labels per row</label>
        <select id="quantitySelect"><option value="">(none — default 1)</option></select>
        <small class="help">If selected, the numeric value in this column will determine how many copies of the label are generated for that row.</small>

        <hr style="margin:12px 0">

        <label>Label size (print mm)</label>
        <div style="display:flex;gap:8px;margin-bottom:8px" id="sizeButtons">
          <button data-size="small">Small 60×40 mm</button>
          <button data-size="medium" class="active">Medium 80×60 mm</button>
          <button data-size="large">Large 100×80 mm</button>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:6px">
          <div>
            <label>Width (mm)</label>
            <input id="labelWmm" type="number" min="20" max="200" step="1" />
          </div>
          <div>
            <label>Height (mm)</label>
            <input id="labelHmm" type="number" min="20" max="200" step="1" />
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:6px">
          <div>
            <label>Page margin (mm)</label>
            <input id="pageMarginInput" type="number" min="0" max="25" step="1" />
          </div>
          <div>
            <label>Label spacing (mm)</label>
            <input id="labelSpacingInput" type="number" min="0" max="10" step="1" />
          </div>
        </div>

        <label style="margin-top:8px">Paper size for PDF</label>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px" id="paperSizeButtons">
          <button data-size="a4" class="active">A4 (210×297 mm)</button>
          <button data-size="letter">Letter (216×279 mm)</button>
          <button data-size="4x6">4"×6" (102×152 mm)</button>
          <button data-size="custom">Custom</button>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:6px" id="customPaperSize" style="display:none">
          <div>
            <label>Width (mm)</label>
            <input id="paperWmm" type="number" min="100" max="500" step="1" />
          </div>
          <div>
            <label>Height (mm)</label>
            <input id="paperHmm" type="number" min="100" max="500" step="1" />
          </div>
        </div>

        <label>Upload logo (PNG/JPG)</label>
        <input id="logoInput" type="file" accept="image/*" />
        <small class="help">Logo will be scaled to fit a small box in top-right with 10px padding.</small>

        <hr style="margin:12px 0">

        <label>Static bilingual text (editable)</label>
        <textarea id="staticText" rows="6" style="width:100%"></textarea>
        <hr style="margin:12px 0">
        <label>Style & Layout</label>
        <div class="cols-list" style="max-height:unset">
          <div style="display:grid;grid-template-columns:repeat(3, 1fr);gap:8px">
            <div>
              <label>Padding (px)</label>
              <input id="padPx" type="number" min="0" max="48" step="1" />
            </div>
            <div>
              <label>Logo box (px)</label>
              <input id="logoBoxPx" type="number" min="16" max="160" step="2" />
            </div>
            <div>
              <label>Logo top (px)</label>
              <input id="logoTopPx" type="number" min="0" max="120" step="1" />
            </div>
            <div>
              <label>Logo right (px)</label>
              <input id="logoRightPx" type="number" min="0" max="120" step="1" />
            </div>
            <div>
              <label>Line 1 size (px)</label>
              <input id="line1Px" type="number" min="8" max="28" step="1" />
            </div>
            <div>
              <label>Line 2 size (px)</label>
              <input id="line2Px" type="number" min="8" max="24" step="1" />
            </div>
            <div>
              <label>Info text size (px)</label>
              <input id="infoPx" type="number" min="8" max="20" step="1" />
            </div>
            <div>
              <label>Dynamic text size (px)</label>
              <input id="dynPx" type="number" min="8" max="22" step="1" />
            </div>
            <div>
              <label>Barcode height (px)</label>
              <input id="bcHeightPx" type="number" min="20" max="120" step="2" />
            </div>
            <div>
              <label>Barcode font (px)</label>
              <input id="bcFontPx" type="number" min="8" max="24" step="1" />
            </div>
          </div>
        </div>

        <div style="margin-top:10px;display:flex;gap:8px">
          <button id="renderBtn">Render Preview</button>
          <button id="generatePdf" style="background:#059669">Generate PDF</button>
          <a id="downloadPdfLink" href="#" download="labels_a4.pdf" style="display:none;background:#10b981;color:#fff;padding:8px 10px;border-radius:8px;text-decoration:none">Download last PDF</a>
          <button id="downloadZip" style="background:#6b7280">Download ZIP (JPEG)</button>
        </div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px">Preview & Controls</h3>

        <!-- Single-label DOM used for html2canvas rendering; will be rendered at high DPI -->
        <div id="labelRenderWrapper" style="display:flex;flex-direction:column;gap:8px">
          <div id="labelCanvasDOM" class="label-preview" style="width: 302px; min-height: 180px;">
            <div id="labelInner" style="position: relative; padding: 12px; box-sizing: border-box; min-height: 130px;">
              <div id="labelContent" style="width: 100%; display: flex; flex-direction: row; justify-content: space-between; align-items: center; gap: 8px;">
                <div id="logoContainer" class="logo-box" style="width: 60px;height: 60px;display: block;align-items: center;border-radius: 4px;overflow: hidden;z-index: 2;right: 0;position: absolute;top: 0;left: 0;"><img src="" style="max-width: 100%; max-height: 100%; display: block;"></div>
                <div style="display:flex;flex-direction:column;width:100%;gap: 4px;">
                  <div id="staticLine1" contenteditable="true" style="font-weight: 700; width: 100%; font-size: 13px; align-items: center; display: flex; flex-direction: column;">
                    <span style="direction: rtl">مستوردة ومسوقة من قبل</span>
                    <span>Imported and Marketed By</span>
                  </div>
                  <div id="staticLine2" contenteditable="true" style="font-size: 11px; display: flex; flex-direction: column; align-items: center; font-weight: 600;"><span>Advista Marketing (P) Ltd</span><span style="direction: rtl">شركة أدفيتا للتسويق المحدودة</span> </div><div id="vatcontact" contenteditable="true" style="font-size:10px;width:100%;align-items: center;display: flex;flex-direction: column;">
                    <span style="direction: rtl">رقم ضريبة القيمة المضافة (VAT): 313061260900003</span>
                    <span>www.layyun.net | info@advistaltd.com</span>
                  </div>
                </div>
              </div>
            
              <div id="dynamicPairs" style="margin-top: 8px; font-size: 11px; display: flex; flex-direction: row; justify-content: space-around;"></div>
              <div id="barcodeArea" style="margin-top:8px;margin-bottom:4px;width:fit-content;padding-left:9%;display:flex;flex-direction:column"></div>
              <div id="staticLine3" contenteditable="true" style="margin-top:8px;font-size:12px;width:100%;display:flex;flex-direction:column;align-items:center;direction: rtl;gap: 1px;">
                <span style="font-weight: bold;"> تركيبة الخامة (Material Composition)</span>
                <span>نايلون + سباندكس (Nylon + Spandex)</span><span style="font-weight: 700;">صنع في الهند | Made in India</span>
              </div>

            </div>
          </div>

          <div>
            <div class="small-muted">Selected mapping (header: value):</div>
            <div id="mappingPreview" style="margin-top:8px"></div>
          </div>
        </div>

      </div>
    </div>

    <p style="margin-top:12px;font-size:13px;color:#666">Notes: Barcode values are validated for EAN-13 (only digits, 12 or 13 chars). PDF generation creates a PDF with selected paper size, placing labels in a grid using chosen label size, page margins and spacing. All done locally.</p>
  </div>

<script>
/* ---------- Utilities ---------- */
const mmToPt = mm => (mm * 72 / 25.4); // not used but handy
const mmToPx = (mm, dpi=300) => Math.round(mm * dpi / 25.4); // convert mm to px at a DPI (for high-res canvas)



let parsedData = []; // array of objects
let headers = [];
let currentLogoDataUrl = null;
let labelSizeMM = {w:80, h:60}; // default medium
let labelDPI = 300; // canvas DPI for export (high quality)
const A4 = {w:210, h:297}; // mm
const LETTER = {w:216, h:279}; // mm
const FOUR_BY_SIX = {w:101.6, h:152.4}; // 4" × 6" in mm
let paperSizeMM = A4; // current paper size
let pageMarginMM = 6; // page margin in mm (reduced to waste less space)
let labelSpacingMM = 2; // spacing between labels (reduced)

/* DOM refs */
const fileInput = document.getElementById('fileInput');
const gsUrl = document.getElementById('gsUrl');
const loadGsBtn = document.getElementById('loadGs');
const clearFileBtn = document.getElementById('clearFile');
const rowSelect = document.getElementById('rowSelect');
const barcodeSelect = document.getElementById('barcodeSelect');
const barcodeNotice = document.getElementById('barcodeNotice');
const colsList = document.getElementById('colsList');
const mappingPreview = document.getElementById('mappingPreview');
const quantitySelect = document.getElementById('quantitySelect');
const sizeButtons = document.getElementById('sizeButtons');
const logoInput = document.getElementById('logoInput');
const labelCanvasDOM = document.getElementById('labelCanvasDOM');
const logoContainer = document.getElementById('logoContainer');
const labelInner = document.getElementById('labelInner');
const downloadPdfLink = document.getElementById('downloadPdfLink');

// UI inputs for sizing/layout
const labelWmmInput = document.getElementById('labelWmm');
const labelHmmInput = document.getElementById('labelHmm');
const pageMarginInput = document.getElementById('pageMarginInput');
const labelSpacingInput = document.getElementById('labelSpacingInput');
const paperSizeButtons = document.getElementById('paperSizeButtons');
const customPaperSize = document.getElementById('customPaperSize');
const paperWmmInput = document.getElementById('paperWmm');
const paperHmmInput = document.getElementById('paperHmm');
const padPxInput = document.getElementById('padPx');
const logoBoxPxInput = document.getElementById('logoBoxPx');
const logoTopPxInput = document.getElementById('logoTopPx');
const logoRightPxInput = document.getElementById('logoRightPx');
const line1PxInput = document.getElementById('line1Px');
const line2PxInput = document.getElementById('line2Px');
const infoPxInput = document.getElementById('infoPx');
const dynPxInput = document.getElementById('dynPx');
const bcHeightPxInput = document.getElementById('bcHeightPx');
const bcFontPxInput = document.getElementById('bcFontPx');
const renderBtn = document.getElementById('renderBtn');
const generatePdfBtn = document.getElementById('generatePdf');
const dynamicPairsEl = document.getElementById('dynamicPairs');
const barcodeArea = document.getElementById('barcodeArea');
const mappingPreviewBox = document.getElementById('mappingPreview');
const staticTextArea = document.getElementById('staticText');
const downloadZipBtn = document.getElementById('downloadZip');

/* ---------- File parse (Excel/CSV) ---------- */
fileInput.addEventListener('change', async (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  const name = f.name.toLowerCase();
  if(name.endsWith('.csv')){
    const text = await f.text();
    parseCSV(text);
  } else {
    const data = await f.arrayBuffer();
    const wb = XLSX.read(data, {type:'array'});
    const first = wb.Sheets[wb.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(first,{defval:''});
    loadParsed(json);
  }
});

loadGsBtn.addEventListener('click', async ()=>{
  const url = gsUrl.value.trim();
  if(!url){ alert('Paste Google Sheets CSV export URL first.'); return; }
  try{
    const res = await fetch(url);
    if(!res.ok) throw new Error('Fetch failed: ' + res.status);
    const text = await res.text();
    parseCSV(text);
  }catch(err){
    alert('Failed to fetch Google Sheets CSV. Ensure sheet is published or accessible as CSV.\n' + err.message);
  }
});

clearFileBtn.addEventListener('click', ()=>{
  parsedData = []; headers = [];
  rowSelect.innerHTML = '<option value="">(no file)</option>';
  barcodeSelect.innerHTML = '<option value="">(choose column)</option>';
  colsList.innerHTML = '';
  quantitySelect.innerHTML = '<option value="">(none)</option>';
  mappingPreviewBox.innerHTML = '';
  fileInput.value = '';
  gsUrl.value = '';
});

/* robust CSV parse via SheetJS */
function parseCSV(text){
  try{
    const wb = XLSX.read(text, {type:'string'});
    const first = wb.Sheets[wb.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(first, {defval:''});
    loadParsed(json);
  }catch(e){
    alert('CSV parse error: ' + e.message);
  }
}

function loadParsed(json){
  parsedData = json;
  if(parsedData.length === 0){
    alert('File parsed but no rows found.');
    return;
  }
  headers = Object.keys(parsedData[0]);
  // populate row selector
  rowSelect.innerHTML = '';
  parsedData.forEach((r,i)=> {
    const opt = document.createElement('option'); opt.value = i;
    opt.textContent = `Row ${i+1} — ${headers.map(h=>String(r[h]).slice(0,10)).slice(0,3).join(' | ')}`;
    rowSelect.appendChild(opt);
  });
  // barcode & quantity selects
  barcodeSelect.innerHTML = '<option value="">(choose column)</option>';
  quantitySelect.innerHTML = '<option value="">(none)</option>';
  headers.forEach(h=>{
    const opt = document.createElement('option'); opt.value = h; opt.textContent = h;
    barcodeSelect.appendChild(opt);
    const qopt = opt.cloneNode(true);
    quantitySelect.appendChild(qopt);
  });
  // columns list
  renderColumnsCheckboxes();
  // auto-select first row for preview
  rowSelect.value = 0;
  updatePreviewFromRow(0);
}

/* render columns checkboxes */
function renderColumnsCheckboxes(){
  colsList.innerHTML = '';
  headers.forEach(h=>{
    const wrapper = document.createElement('div');
    wrapper.style.display='flex'; wrapper.style.justifyContent='space-between'; wrapper.style.alignItems='center'; wrapper.style.marginBottom='6px';
    const left = document.createElement('div');
    left.innerHTML = `<label style="font-weight:600">${h}</label><div style="font-size:12px;color:#666">will render as: <strong>${h}: [value]</strong></div>`;
    const cb = document.createElement('input'); cb.type='checkbox'; cb.dataset.col = h;
    cb.addEventListener('change', renderMappingPreview);
    wrapper.appendChild(left); wrapper.appendChild(cb);
    colsList.appendChild(wrapper);
  });
}

/* update preview when row changes */
rowSelect.addEventListener('change', (e)=>{
  const idx = e.target.value;
  if(idx==='') return;
  updatePreviewFromRow(parseInt(idx,10));
});

function updatePreviewFromRow(index){
  if(!parsedData[index]) return;
  const row = parsedData[index];
  // barcode notice
  const chosenBarcode = barcodeSelect.value;
  if(chosenBarcode){
    const bc = String(row[chosenBarcode] ?? '');
    barcodeNotice.style.display = 'block';
    barcodeNotice.innerHTML = `<strong>Check barcode value:</strong> <span style="font-weight:700">${bc}</span><br><small>EAN-13 requires 12 or 13 numeric digits — non-digits will be stripped.</small>`;
  } else {
    barcodeNotice.style.display = 'none';
  }
  renderMappingPreview();
}

/* barcode select change */
barcodeSelect.addEventListener('change', ()=>{
  const idx = rowSelect.value;
  if(idx === '') return;
  updatePreviewFromRow(parseInt(idx,10));
});

/* logo upload */
logoInput.addEventListener('change', (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = (ev)=>{
    currentLogoDataUrl = ev.target.result;
    // show small in preview
    logoContainer.innerHTML = '';
    const img = document.createElement('img');
    img.src = currentLogoDataUrl;
    img.style.maxWidth = '100%';
    img.style.maxHeight = '100%';
    img.style.display = 'block';
    logoContainer.appendChild(img);
    // enforce small size (will be scaled in render)
  };
  reader.readAsDataURL(f);
});

/* mapping preview & dynamic pairs */
function renderMappingPreview(){
  mappingPreviewBox.innerHTML = '';
  dynamicPairsEl.innerHTML = '';
  const selected = Array.from(colsList.querySelectorAll('input[type=checkbox]:checked')).map(cb=>cb.dataset.col);
  const idx = rowSelect.value;
  if(idx==='' || !parsedData[idx]) return;
  const row = parsedData[idx];
  selected.forEach(col=>{
    const p = document.createElement('div'); p.className='pair'; p.textContent = `${col}: ${row[col] ?? ''}`;
    mappingPreviewBox.appendChild(p);
    // also add into label dynamicPairsEl
    const d = document.createElement('div'); d.style.marginBottom='6px'; d.innerHTML = `<strong>${col}:</strong> <span>${row[col] ?? ''}</span>`;
    dynamicPairsEl.appendChild(d);
  });
  // Static lines: do not override user's custom markup by default.
  // If you want a block to be driven by the textarea, add data-auto="static" to it.
  const staticLines = staticTextArea.value.split('\n').map(s=>s.trim()).filter(Boolean);
  const ids = ['staticLine1','staticLine2','staticLine3','staticLine4','staticLine5','staticLine6'];
  ids.forEach((id, i)=>{
    const el = document.getElementById(id);
    if(el && el.getAttribute('data-auto') === 'static'){
      el.textContent = staticLines[i] || '';
    }
  });

  // barcode rendering for preview
  renderBarcodePreview();
}

/* render barcode preview using JsBarcode into svg/canvas */
function renderBarcodePreview(){
  barcodeArea.innerHTML = '';
  const idx = rowSelect.value;
  if(idx==='' || !parsedData[idx]) return;
  const row = parsedData[idx];
  const col = barcodeSelect.value;
  if(!col) return;
  let val = String(row[col] ?? '');
  // strip non-digits
  val = val.replace(/\D/g,'');
  if(val.length < 12){
    const msg = document.createElement('div'); msg.style.color='#b02a37'; msg.textContent = 'EAN-13 needs 12 (auto-checksum) or 13 digits. Value has ' + val.length + ' digits after stripping non-digits.';
    barcodeArea.appendChild(msg);
    return;
  }
  // create canvas for JsBarcode
  const canvas = document.createElement('canvas');
  try {
    const h = getIntValue(bcHeightPxInput, 40);
    const f = getIntValue(bcFontPxInput, 12);
    JsBarcode(canvas, val, {format:'ean13', displayValue:true, fontSize:f, height:h, margin:4});
    barcodeArea.appendChild(canvas);
  } catch(err){
    const msg = document.createElement('div'); msg.style.color='#b02a37'; msg.textContent = 'Barcode render error: ' + err.message;
    barcodeArea.appendChild(msg);
  }
}

/* size buttons */
sizeButtons.addEventListener('click', (e)=>{
  if(!e.target.dataset || !e.target.dataset.size) return;
  const size = e.target.dataset.size;
  Array.from(sizeButtons.querySelectorAll('button')).forEach(b=>b.classList.remove('active'));
  e.target.classList.add('active');
  if(size==='small') labelSizeMM = {w:60, h:40};
  else if(size==='medium') labelSizeMM = {w:80, h:60};
  else labelSizeMM = {w:100, h:80};
  // update preview width approx
  const pxW = Math.round(labelSizeMM.w * 3.78); // ~96dpi just for UI
  labelCanvasDOM.style.width = pxW + 'px';
});

/* paper size buttons */
paperSizeButtons.addEventListener('click', (e)=>{
  if(!e.target.dataset || !e.target.dataset.size) return;
  const size = e.target.dataset.size;
  Array.from(paperSizeButtons.querySelectorAll('button')).forEach(b=>b.classList.remove('active'));
  e.target.classList.add('active');
  if(size==='a4') {
    paperSizeMM = A4;
    customPaperSize.style.display = 'none';
  } else if(size==='letter') {
    paperSizeMM = LETTER;
    customPaperSize.style.display = 'none';
  } else if(size==='4x6') {
    paperSizeMM = FOUR_BY_SIX;
    customPaperSize.style.display = 'none';
  } else if(size==='custom') {
    customPaperSize.style.display = 'grid';
    // Use current values or defaults
    if(!paperWmmInput.value) paperWmmInput.value = '210';
    if(!paperHmmInput.value) paperHmmInput.value = '297';
    paperSizeMM = {w: parseInt(paperWmmInput.value), h: parseInt(paperHmmInput.value)};
  }
});

/* render preview button */
renderBtn.addEventListener('click', ()=>{
  renderMappingPreview();
  alert('Preview rendered on right. If barcode value is not valid for EAN-13 check the barcode column or data.');
});

/* ---------- PDF generation ---------- */
generatePdfBtn.addEventListener('click', async ()=>{
  if(!parsedData || parsedData.length===0){ alert('Load a sheet first'); return; }
  // Build list of label rows to generate (respect quantity column)
  const qtyCol = quantitySelect.value;
  const chosenBarcodeCol = barcodeSelect.value;
  const selectedCols = Array.from(colsList.querySelectorAll('input[type=checkbox]:checked')).map(cb=>cb.dataset.col);
  if(!chosenBarcodeCol){ if(!confirm('No barcode column selected. Continue without barcode?')) return; }

  // Build flat array of items (each item corresponds to one label instance)
  const items = [];
  parsedData.forEach((row, rowIndex)=>{
    // Quantity
    let qty = 1;
    if(qtyCol){
      qty = parsePositiveQuantity(row[qtyCol]);
      if(qty <= 0){ return; }
    }

    // Skip when barcode column exists and value is null/0
    if(chosenBarcodeCol){
      const rawBc = String(row[chosenBarcodeCol] ?? '').replace(/\D/g,'').trim();
      const isEmptyOrZero = !rawBc || /^0+$/.test(rawBc);
      if(isEmptyOrZero){
        return; // ignore this row
      }
    }

    for(let i=0;i<qty;i++) items.push({rowIndex, row});
  });

  if(items.length === 0){ alert('No labels to generate (0 items).'); return; }
  // For performance/preview ask user? but requirement forbids wait — proceed.

  // Calculate grid layout for selected paper size
  const usableW = paperSizeMM.w - 2*pageMarginMM;
  const usableH = paperSizeMM.h - 2*pageMarginMM;
  const cols = Math.floor( (usableW + labelSpacingMM) / (labelSizeMM.w + labelSpacingMM) );
  const rows = Math.floor( (usableH + labelSpacingMM) / (labelSizeMM.h + labelSpacingMM) );
  if(cols < 1 || rows < 1){ alert('Label size too large to fit on selected paper size with current margins. Choose a smaller label size or reduce margins.'); return; }
  const perPage = cols * rows;

  // Show quick information
  const pagesNeeded = Math.ceil(items.length / perPage);
  const totalRequestedQty = items.length;
  const paperSizeName = paperSizeMM === A4 ? 'A4' : paperSizeMM === LETTER ? 'Letter' : paperSizeMM === FOUR_BY_SIX ? '4"×6"' : 'Custom';
  if(!confirm(`Generating ${totalRequestedQty} labels → ${pagesNeeded} ${paperSizeName} page(s).\nLabels per page: ${perPage} (${cols}×${rows}). Proceed?`)) return;
  
  // Add progress indicator
  const progressDiv = document.createElement('div');
  progressDiv.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.8);color:white;padding:20px;border-radius:10px;z-index:10000;text-align:center;';
  progressDiv.innerHTML = '<div>Generating PDF...</div><div id="pdfProgress">0%</div>';
  document.body.appendChild(progressDiv);

  // Fast DOM-to-Canvas renderer with caching and batch processing
  const __renderCache = new Map();
  const __barcodeCache = new Map();
  function rowCacheKey(row){
    try{ return JSON.stringify(row); }catch(_){ return String(Math.random()); }
  }
  
  // Batch processing for better performance (parallel renders)
  async function processBatch(items, batchSize = 6) {
    const results = [];
    for (let i = 0; i < items.length; i += batchSize) {
      const batch = items.slice(i, i + batchSize);
      const batchPromises = batch.map(item => renderLabelToDataUrl(item.row, selectedCols));
      const batchResults = await Promise.all(batchPromises);
      results.push(...batchResults);
      
      // Update progress
      const progress = Math.round((results.length / items.length) * 100);
      const progressEl = document.getElementById('pdfProgress');
      if(progressEl) progressEl.textContent = `${progress}%`;
    }
    return results;
  }
  
  // Cache barcode rendering to avoid repeated JsBarcode work
  async function getBarcodeDataUrl(value, height, fontSize){
    const key = `${value}|${height}|${fontSize}`;
    if(__barcodeCache.has(key)) return __barcodeCache.get(key);
    const cvs = document.createElement('canvas');
    JsBarcode(cvs, value, {format:'ean13', displayValue:true, fontSize, height, margin:4});
    const url = cvs.toDataURL('image/png');
    __barcodeCache.set(key, url);
    return url;
  }
  async function renderLabelToDataUrl(row, selectedCols){
    const key = rowCacheKey(row);
    if(__renderCache.has(key)) return __renderCache.get(key);

    // Render by cloning the live preview DOM and rasterizing with html2canvas
    return await renderLabelWithHtml2Canvas(row, selectedCols, key);
  }

  // Exact DOM-to-canvas render using html2canvas so PDF matches preview
  async function renderLabelWithHtml2Canvas(row, selectedCols, key){
    // Create offscreen wrapper
    const wrapper = document.createElement('div');
    wrapper.style.cssText = 'position:fixed;left:-10000px;top:0;z-index:-1;background:white;';

    // Clone the current preview label DOM so styles/layout are identical
    const clone = labelCanvasDOM.cloneNode(true);

    // Force physical size in CSS pixels (96dpi) to match preview proportions
    const cssW = Math.round(labelSizeMM.w * 3.78);
    const cssH = Math.round(labelSizeMM.h * 3.78);
    clone.style.width = cssW + 'px';
    clone.style.minHeight = cssH + 'px';

     // Do NOT override static lines - preserve the exact HTML structure from preview
     // Only update static lines if they have data-auto="static" attribute

    // Rebuild dynamic pairs exactly like preview (space-around row)
    const dynContainer = clone.querySelector('#dynamicPairs');
    if(dynContainer){
      dynContainer.innerHTML = '';
      selectedCols.forEach(col=>{
        const d = document.createElement('div');
        d.style.marginBottom = '6px';
        d.innerHTML = `<strong>${col}:</strong> <span>${row[col] ?? ''}</span>`;
        dynContainer.appendChild(d);
      });
    }

    // Render barcode inside the clone
    const bcEl = clone.querySelector('#barcodeArea');
    if(bcEl){
      bcEl.innerHTML = '';
      const chosenBarcodeColVal = chosenBarcodeCol ? String(row[chosenBarcodeCol] ?? '').replace(/\D/g,'') : '';
      if(chosenBarcodeColVal){
        const canvas = document.createElement('canvas');
        const h = getIntValue(bcHeightPxInput, 40);
        const f = getIntValue(bcFontPxInput, 12);
        try{
          JsBarcode(canvas, chosenBarcodeColVal, {format:'ean13', displayValue:true, fontSize:f, height:h, margin:4});
          bcEl.appendChild(canvas);
        }catch{ /* ignore barcode errors for this row */ }
      }
    }

    // Ensure logo is present in the clone when uploaded
    const cloneLogoContainer = clone.querySelector('#logoContainer');
    if(cloneLogoContainer && currentLogoDataUrl){
      // Replace placeholder with image if missing
      if(!cloneLogoContainer.querySelector('img')){
        cloneLogoContainer.innerHTML = '';
        const img = document.createElement('img');
        img.src = currentLogoDataUrl;
        img.style.maxWidth = '100%';
        img.style.maxHeight = '100%';
        img.style.display = 'block';
        cloneLogoContainer.appendChild(img);
      }
    }

    wrapper.appendChild(clone);
    document.body.appendChild(wrapper);

    // High-DPI render so size in PDF is crisp and matches mm
    const scale = labelDPI / 96; // 96 CSS px per inch baseline
    const canvas = await html2canvas(clone, {backgroundColor:'#ffffff', scale});

    // Cleanup
    document.body.removeChild(wrapper);

    const pxW = canvas.width; // already scaled
    const pxH = canvas.height;
    const dataUrl = canvas.toDataURL('image/png', 0.92);
    const result = { dataUrl, pxW, pxH };
    __renderCache.set(key, result);
    return result;
  }
  

  // Compose pages using jsPDF
  const { jsPDF } = window.jspdf;
  let pdfFormat = 'a4';
  if(paperSizeMM === LETTER) {
    pdfFormat = 'letter';
  } else if(paperSizeMM === FOUR_BY_SIX) {
    // 4" × 6" size - use array format [width, height] in mm
    pdfFormat = [paperSizeMM.w, paperSizeMM.h];
  } else if(paperSizeMM !== A4) {
    // Custom size - use array format [width, height] in mm
    pdfFormat = [paperSizeMM.w, paperSizeMM.h];
  }
  const pdf = new jsPDF({unit:'mm', format:pdfFormat, compress:true});

  // compute positions with safety checks
  const colsPerPage = cols;
  const rowsPerPage = rows;
  const spacing = labelSpacingMM;
  const startX = pageMarginMM;
  const startY = pageMarginMM;
  
  // Verify that labels fit within page boundaries
  const totalWidth = colsPerPage * labelSizeMM.w + (colsPerPage - 1) * spacing;
  const totalHeight = rowsPerPage * labelSizeMM.h + (rowsPerPage - 1) * spacing;
  const maxWidth = paperSizeMM.w - 2 * pageMarginMM;
  const maxHeight = paperSizeMM.h - 2 * pageMarginMM;
  
  if(totalWidth > maxWidth || totalHeight > maxHeight) {
    alert(`Warning: Labels may not fit properly on page. Calculated: ${totalWidth.toFixed(1)}×${totalHeight.toFixed(1)}mm, Available: ${maxWidth.toFixed(1)}×${maxHeight.toFixed(1)}mm`);
  }

  // Pre-render all labels in batches for better performance
  const cores = (navigator && navigator.hardwareConcurrency) ? navigator.hardwareConcurrency : 4;
  const batchSizeOpt = Math.min(8, Math.max(4, cores * 2));
  const renderedLabels = await processBatch(items, batchSizeOpt);
  
  // Now compose PDF pages with pre-rendered labels
  let pageIndex = 0;
  let labelIndex = 0;

  while(labelIndex < items.length){
    if(pageIndex > 0) pdf.addPage();
    // for each row & col on page:
    for(let r=0;r<rowsPerPage;r++){
      for(let c=0;c<colsPerPage;c++){
        const globalIndex = pageIndex*perPage + r*colsPerPage + c;
        if(globalIndex >= items.length) break;
        
        // compute x,y in mm with safety bounds
        const x = Math.max(0, startX + c*(labelSizeMM.w + spacing));
        const y = Math.max(0, startY + r*(labelSizeMM.h + spacing));
        
        // Ensure label doesn't exceed page boundaries
        const labelRight = x + labelSizeMM.w;
        const labelBottom = y + labelSizeMM.h;
        if(labelRight > paperSizeMM.w || labelBottom > paperSizeMM.h) {
          console.warn(`Label at (${x}, ${y}) exceeds page boundaries. Skipping.`);
          continue;
        }
        
        // Use pre-rendered label
        const renderedItem = renderedLabels[globalIndex];
        if(renderedItem && renderedItem.dataUrl) {
          pdf.addImage(renderedItem.dataUrl, 'PNG', x, y, labelSizeMM.w, labelSizeMM.h);
        } else {
          console.error('Failed to render label for index:', globalIndex);
          pdf.text('Render error', x+5, y+10);
        }
        labelIndex++;
      }
      if(labelIndex >= items.length) break;
    }
    pageIndex++;
  }

  // Clean up progress indicator
  if(progressDiv && progressDiv.parentNode) {
    progressDiv.parentNode.removeChild(progressDiv);
  }
  
  // finalize: download and expose link
  try{
    const blob = pdf.output('blob');
    const url = URL.createObjectURL(blob);
    downloadPdfLink.href = url;
    downloadPdfLink.style.display = 'inline-block';
  }catch(e){
    console.warn('Could not create blob URL for download link', e);
  }
  const fileName = paperSizeMM === A4 ? 'labels_a4.pdf' : paperSizeMM === LETTER ? 'labels_letter.pdf' : paperSizeMM === FOUR_BY_SIX ? 'labels_4x6.pdf' : 'labels_custom.pdf';
  pdf.save(fileName);
  alert('PDF generated and downloaded. Pages: ' + pageIndex);
});
/* ---------- Shared renderer used by ZIP and PDF (global scope) ---------- */
const __globalRenderCache = new Map();
const __globalBarcodeCache = new Map();
async function renderLabelToDataUrl(row, selectedCols){
  // Build cache key from row + important knobs
  let key;
  try{
    key = JSON.stringify({row, selectedCols, size:labelSizeMM, dpi:labelDPI, staticText:staticTextArea.value, hasLogo:!!currentLogoDataUrl});
  }catch(_){ key = String(Math.random()); }
  if(__globalRenderCache.has(key)) return __globalRenderCache.get(key);

  // Offscreen container and clone of preview
  const wrapper = document.createElement('div');
  wrapper.style.cssText = 'position:fixed;left:-10000px;top:0;background:#fff;z-index:-1;';
  const clone = labelCanvasDOM.cloneNode(true);

  // Force CSS size to match preview aspect (96dpi css pixels)
  const cssW = Math.round(labelSizeMM.w * 3.78);
  const cssH = Math.round(labelSizeMM.h * 3.78);
  clone.style.width = cssW + 'px';
  clone.style.minHeight = cssH + 'px';

   // Do NOT override static lines - preserve the exact HTML structure from preview
   // Only update static lines if they have data-auto="static" attribute

  // Dynamic pairs
  const dyn = clone.querySelector('#dynamicPairs');
  if(dyn){
    dyn.innerHTML = '';
    selectedCols.forEach(col=>{
      const d = document.createElement('div');
      d.style.marginBottom = '6px';
      d.innerHTML = `<strong>${col}:</strong> <span>${row[col] ?? ''}</span>`;
      dyn.appendChild(d);
    });
  }

  // Barcode inside clone if column chosen
  const bcEl = clone.querySelector('#barcodeArea');
  if(bcEl){
    bcEl.innerHTML = '';
    const col = barcodeSelect.value;
    const raw = col ? String(row[col] ?? '').replace(/\D/g,'') : '';
    if(raw){
      const h = getIntValue(bcHeightPxInput, 40);
      const f = getIntValue(bcFontPxInput, 12);
      const bKey = `${raw}|${h}|${f}`;
      if(__globalBarcodeCache.has(bKey)){
        const img = new Image(); img.src = __globalBarcodeCache.get(bKey); bcEl.appendChild(img);
      } else {
        const cvs = document.createElement('canvas');
        try{ cvs.getContext('2d', {willReadFrequently:true}); }catch(_){ }
        try{
          JsBarcode(cvs, raw, {format:'ean13', displayValue:true, fontSize:f, height:h, margin:4});
          const url = cvs.toDataURL('image/png');
          __globalBarcodeCache.set(bKey, url);
          const img = new Image(); img.src = url; bcEl.appendChild(img);
        }catch(_){ /* ignore */ }
      }
    }
  }

  // Ensure logo present
  const cloneLogo = clone.querySelector('#logoContainer');
  if(cloneLogo && currentLogoDataUrl){
    if(!cloneLogo.querySelector('img')){
      cloneLogo.innerHTML = '';
      const img = document.createElement('img');
      img.src = currentLogoDataUrl;
      img.style.maxWidth = '100%';
      img.style.maxHeight = '100%';
      img.style.display = 'block';
      cloneLogo.appendChild(img);
    }
  }

  wrapper.appendChild(clone);
  document.body.appendChild(wrapper);

  const scale = labelDPI / 96;
  const canvas = await html2canvas(clone, {backgroundColor:'#ffffff', scale});
  document.body.removeChild(wrapper);

  const result = { dataUrl: canvas.toDataURL('image/png', 0.92), pxW: canvas.width, pxH: canvas.height };
  __globalRenderCache.set(key, result);
  return result;
}
/* ---------- ZIP (PNG) download ---------- */
downloadZipBtn.addEventListener('click', async ()=>{
  if(!parsedData || parsedData.length===0){ alert('Load a sheet first'); return; }
  const qtyCol = quantitySelect.value;
  const selectedCols = Array.from(colsList.querySelectorAll('input[type=checkbox]:checked')).map(cb=>cb.dataset.col);
  
  // Build one entry per row (no duplication by quantity). File name encodes selected columns and qty
  const rowsForZip = [];
  const usedNameCounts = new Map();
  function sanitizeName(s){
    return String(s ?? '').toLowerCase().replace(/[^a-z0-9]+/gi,'-').replace(/^-+|-+$/g,'').slice(0,60) || 'na';
  }
  function uniqueBase(base){
    const n = usedNameCounts.get(base) || 0;
    usedNameCounts.set(base, n+1);
    return n === 0 ? base : `${base}-${n+1}`;
  }
  parsedData.forEach((row, idx)=>{
    // Quantity
    let qty = 1;
    if(qtyCol){
      qty = parsePositiveQuantity(row[qtyCol]);
      if(qty <= 0){ return; }
    }
    // Skip when barcode column exists and value is null/0
    const chosenBarcodeCol = barcodeSelect.value;
    if(chosenBarcodeCol){
      const rawBc = String(row[chosenBarcodeCol] ?? '').replace(/\D/g,'').trim();
      const isEmptyOrZero = !rawBc || /^0+$/.test(rawBc);
      if(isEmptyOrZero){
        return; // ignore this row
      }
    }
    const parts = selectedCols.map(col=>`${sanitizeName(col)}-${sanitizeName(row[col])}`);
    const base = parts.length ? parts.join('_') : `row-${idx+1}`;
    const fileBase = uniqueBase(`${base}_qty-${qty}`);
    rowsForZip.push({row, fileBase});
  });
  if(rowsForZip.length === 0){ alert('No labels to generate (0 items).'); return; }

  const zip = new JSZip();
  for(let i=0;i<rowsForZip.length;i++){
    const r = await renderLabelToDataUrl(rowsForZip[i].row, selectedCols);
    if(r && r.dataUrl) {
      // convert dataURL to blob and then to JPEG with metadata
      const resp = await fetch(r.dataUrl);
      const blob = await resp.blob();
      
      // Create JPEG with dimensional metadata
      const jpegBlob = await addDimensionalMetadata(blob, labelSizeMM);
      
      const safeName = rowsForZip[i].fileBase || `label_${(i+1).toString().padStart(4,'0')}`;
      zip.file(`${safeName}.jpg`, jpegBlob);
    }
  }
  const zipBlob = await zip.generateAsync({type:'blob'});
  const url = URL.createObjectURL(zipBlob);
  const a = document.createElement('a');
  a.href = url; a.download = 'labels_jpeg.zip';
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  setTimeout(()=> URL.revokeObjectURL(url), 1000);
});

/* ---------- Helpers ---------- */
function escapeHtml(s){
  if(!s) return '';
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// Add dimensional metadata to JPEG images
async function addDimensionalMetadata(pngBlob, dimensions) {
  return new Promise((resolve) => {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const img = new Image();
    
    img.onload = () => {
      // Set canvas size to match image
      canvas.width = img.width;
      canvas.height = img.height;
      
      // Draw the image
      ctx.drawImage(img, 0, 0);
      
      // Add dimensional information as text overlay (bottom right corner)
      const fontSize = Math.max(8, Math.min(16, canvas.width / 50));
      ctx.font = `${fontSize}px Arial`;
      ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
      ctx.fillRect(canvas.width - 120, canvas.height - 25, 115, 20);
      
      ctx.fillStyle = 'white';
      ctx.textAlign = 'right';
      ctx.fillText(`${dimensions.w}×${dimensions.h}mm`, canvas.width - 5, canvas.height - 10);
      
      // Convert to JPEG with quality 0.92 (same as PDF generation)
      const jpegDataUrl = canvas.toDataURL('image/jpeg', 0.92);
      
      // Convert data URL to blob
      fetch(jpegDataUrl).then(resp => resp.blob()).then(jpegBlob => {
        resolve(jpegBlob);
      });
    };
    
    img.src = URL.createObjectURL(pngBlob);
  });
}
function mmToPxRounded(mm, dpi=300){ return Math.round(mm * dpi / 25.4); }

// Robust quantity parser: returns integer >= 0
function parsePositiveQuantity(raw){
  if(raw == null) return 0;
  const str = String(raw).trim();
  if(str === '') return 0;
  // extract first signed/unsigned number segment
  const m = str.match(/-?\d+(?:[\.,]\d+)?/);
  if(!m) return 0;
  const n = Number(m[0].replace(',', '.'));
  if(!Number.isFinite(n)) return 0;
  const q = Math.floor(n);
  return q > 0 ? q : 0;
}

/* Keep preview synced when quantity column selection or checkboxes change */
quantitySelect.addEventListener('change', ()=>{/* nothing for preview */});
colsList.addEventListener('change', ()=>{/* delegated via checkboxes */});

/* Auto heuristics for common column names */
function autoSelectHeuristics(){
  if(!headers || headers.length===0) return;
  const low = headers.map(h=>h.toLowerCase());
  const picks = [];
  ['barcode','sku','ean','upc','code'].forEach(k=>{
    const idx = low.findIndex(h=>h.includes(k));
    if(idx>=0) picks.push(headers[idx]);
  });
  ['name','title','description'].forEach(k=>{
    const idx = low.findIndex(h=>h.includes(k));
    if(idx>=0) picks.push(headers[idx]);
  });
  // mark checkboxes
  Array.from(colsList.querySelectorAll('input[type=checkbox]')).forEach(cb=>{
    if(picks.includes(cb.dataset.col)) cb.checked = true;
  });
}
const obs = new MutationObserver(()=> autoSelectHeuristics());
obs.observe(colsList, {childList:true, subtree:true});

/* initial UI sizing */
labelCanvasDOM.style.width = '300px';
labelCanvasDOM.style.minHeight = '180px';

/* when barcode col or row changes, rerender preview */
rowSelect.addEventListener('change', renderMappingPreview);
barcodeSelect.addEventListener('change', renderMappingPreview);

/* ---------- New: style controls binding ---------- */
function getIntValue(inputEl, fallback){
  const n = parseInt(String(inputEl && inputEl.value || '').trim(), 10);
  return Number.isFinite(n) ? n : fallback;
}

function applyStyleControlsToPreview(){
  const padPx = getIntValue(padPxInput, 12);
  const logoBoxPx = getIntValue(logoBoxPxInput, 60);
  const logoTopPx = getIntValue(logoTopPxInput, 10);
  const logoRightPx = getIntValue(logoRightPxInput, 10);
  const line1Px = getIntValue(line1PxInput, 14);
  const line2Px = getIntValue(line2PxInput, 12);
  const infoPx = getIntValue(infoPxInput, 11);
  const dynPx = getIntValue(dynPxInput, 12);

  if(labelInner) labelInner.style.padding = padPx + 'px';
  if(logoContainer){
    logoContainer.style.top = logoTopPx + 'px';
    logoContainer.style.right = logoRightPx + 'px';
    logoContainer.style.width = logoBoxPx + 'px';
    logoContainer.style.height = logoBoxPx + 'px';
  }
  const labelContentEl = document.getElementById('labelContent');
  if(labelContentEl) labelContentEl.style.paddingRight = (getIntValue(logoRightPxInput, 10) + getIntValue(logoBoxPxInput, 60) + 12) + 'px';
  const staticLine1El = document.getElementById('staticLine1');
  const staticLine2El = document.getElementById('staticLine2');
  if(staticLine1El) staticLine1El.style.fontSize = line1Px + 'px';
  if(staticLine2El) staticLine2El.style.fontSize = line2Px + 'px';
  const dynEl = document.getElementById('dynamicPairs');
  if(dynEl) dynEl.style.fontSize = dynPx + 'px';
  // bottom info container font size set via inline style container; re-apply with mapping preview
  renderBarcodePreview();
}

// initialize inputs with defaults and bind events
labelWmmInput.value = String(labelSizeMM.w);
labelHmmInput.value = String(labelSizeMM.h);
pageMarginInput.value = String(pageMarginMM);
labelSpacingInput.value = String(labelSpacingMM);
padPxInput.value = '12';
logoBoxPxInput.value = '60';
logoTopPxInput.value = '10';
logoRightPxInput.value = '10';
line1PxInput.value = '14';
line2PxInput.value = '12';
infoPxInput.value = '11';
dynPxInput.value = '12';
bcHeightPxInput.value = '40';
bcFontPxInput.value = '12';
applyStyleControlsToPreview();

labelWmmInput.addEventListener('change', ()=>{
  const w = getIntValue(labelWmmInput, labelSizeMM.w);
  labelSizeMM.w = Math.max(20, Math.min(200, w));
  const pxW = Math.round(labelSizeMM.w * 3.78);
  labelCanvasDOM.style.width = pxW + 'px';
});
labelHmmInput.addEventListener('change', ()=>{
  const h = getIntValue(labelHmmInput, labelSizeMM.h);
  labelSizeMM.h = Math.max(20, Math.min(200, h));
});
pageMarginInput.addEventListener('change', ()=>{
  pageMarginMM = Math.max(0, Math.min(25, getIntValue(pageMarginInput, pageMarginMM)));
});
labelSpacingInput.addEventListener('change', ()=>{
  labelSpacingMM = Math.max(0, Math.min(10, getIntValue(labelSpacingInput, labelSpacingMM)));
});

/* custom paper size inputs */
paperWmmInput.addEventListener('change', ()=>{
  if(customPaperSize.style.display === 'grid') {
    const w = Math.max(100, Math.min(500, getIntValue(paperWmmInput, 210)));
    paperSizeMM.w = w;
    paperWmmInput.value = w; // Update input to show clamped value
  }
});
paperHmmInput.addEventListener('change', ()=>{
  if(customPaperSize.style.display === 'grid') {
    const h = Math.max(100, Math.min(500, getIntValue(paperHmmInput, 297)));
    paperSizeMM.h = h;
    paperHmmInput.value = h; // Update input to show clamped value
  }
});
[padPxInput, logoBoxPxInput, logoTopPxInput, logoRightPxInput, line1PxInput, line2PxInput, infoPxInput, dynPxInput, bcHeightPxInput, bcFontPxInput].forEach(el=>{
  el.addEventListener('change', applyStyleControlsToPreview);
  el.addEventListener('input', applyStyleControlsToPreview);
});

// Sync contenteditable static lines with textarea and preview
['staticLine1','staticLine2','staticLine3','staticLine4'].forEach(id=>{
  const el = document.getElementById(id);
  if(!el) return;
  el.addEventListener('input', ()=>{
    const lines = ['staticLine1','staticLine2','staticLine3','staticLine4'].map(k=>{
      const n = document.getElementById(k);
      return n ? n.textContent.trim() : '';
    });
    staticTextArea.value = lines.filter(Boolean).join('\n');
    renderMappingPreview();
  });
});
staticTextArea.addEventListener('input', ()=>{
  renderMappingPreview();
});

</script>
</body>
</html>
