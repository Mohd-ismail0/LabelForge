<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Label Maker — EAN13 + A4 PDF</title>

  <!-- SheetJS (xlsx) -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <!-- JsBarcode for EAN13 -->
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <!-- html2canvas for rendering label to canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <!-- jsPDF for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root{--accent:#2c7be5;--muted:#666;}
    body{font-family:Arial, Helvetica, sans-serif;background:#f2f5fb;margin:0;padding:18px;color:#111}
    .container{max-width:1200px;margin:0 auto}
    h1{font-size:20px;margin:0 0 8px}
    .card{background:#fff;padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(20,20,40,0.06)}
    .grid{display:grid;grid-template-columns:1fr 420px;gap:12px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input, select, textarea, button{font-size:14px;padding:8px;border-radius:8px;border:1px solid #d6dbe8}
    button{cursor:pointer;background:var(--accent);color:#fff;border:none}
    .cols-list{max-height:200px;overflow:auto;border:1px dashed #d6dbe8;padding:8px;border-radius:6px}
    .label-preview{background:#fff;padding:10px;border-radius:8px;border:1px solid #e6eefb;min-height:200px;display:flex;flex-direction:column}
    .logo-box{position:relative}
    .logo-topright{position:absolute;right:10px;top:10px;max-width:60px;max-height:60px;padding:0}
    .pair{background:#f3f6fb;padding:6px;border-radius:5px;margin-bottom:6px}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    small{color:var(--muted)}
    .help{font-size:13px;color:#555;margin-top:6px}
  </style>
</head>
<body>
  <div class="container">
    <h1>Label Maker — EAN13 + A4 PDF (Excel/CSV/Google Sheets)</h1>
    <p class="help">Upload sheet, choose barcode column (EAN13), choose dynamic columns, pick a quantity column to multiply labels, select label size, upload logo (will be rendered top-right with 10px padding), then "Generate A4 PDF".</p>

    <div class="grid" style="margin-top:12px">
      <div class="card">
        <label>Upload Excel / CSV file</label>
        <input id="fileInput" type="file" accept=".xlsx,.xls,.csv" />
        <label style="margin-top:8px">Or paste Google Sheets CSV URL</label>
        <input id="gsUrl" type="text" placeholder="https://docs.google.com/spreadsheets/d/.../export?format=csv&sheet=Sheet1" />
        <div style="margin-top:8px;display:flex;gap:8px">
          <button id="loadGs">Load Google Sheets CSV</button>
          <button id="clearFile" style="background:#ddd;color:#111">Clear</button>
        </div>

        <hr style="margin:12px 0">

        <label>Choose row for preview</label>
        <select id="rowSelect"><option value="">(no file)</option></select>

        <label style="margin-top:8px">Barcode column (EAN-13)</label>
        <select id="barcodeSelect"><option value="">(choose column)</option></select>
        <div id="barcodeNotice" style="margin-top:8px;display:none;background:#fff7e6;padding:8px;border-radius:6px;border:1px solid #ffe8b3"></div>

        <hr style="margin:12px 0">

        <label>Select dynamic columns to render (header: value)</label>
        <div class="cols-list" id="colsList"></div>

        <label style="margin-top:8px">Quantity column (optional) — numeric column that multiplies labels per row</label>
        <select id="quantitySelect"><option value="">(none — default 1)</option></select>
        <small class="help">If selected, the numeric value in this column will determine how many copies of the label are generated for that row.</small>

        <hr style="margin:12px 0">

        <label>Label size (print mm)</label>
        <div style="display:flex;gap:8px;margin-bottom:8px" id="sizeButtons">
          <button data-size="small">Small 60×40 mm</button>
          <button data-size="medium" class="active">Medium 80×60 mm</button>
          <button data-size="large">Large 100×80 mm</button>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:6px">
          <div>
            <label>Width (mm)</label>
            <input id="labelWmm" type="number" min="20" max="200" step="1" />
          </div>
          <div>
            <label>Height (mm)</label>
            <input id="labelHmm" type="number" min="20" max="200" step="1" />
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:6px">
          <div>
            <label>Page margin (mm)</label>
            <input id="pageMarginInput" type="number" min="0" max="25" step="1" />
          </div>
          <div>
            <label>Label spacing (mm)</label>
            <input id="labelSpacingInput" type="number" min="0" max="10" step="1" />
          </div>
        </div>

        <label>Upload logo (PNG/JPG)</label>
        <input id="logoInput" type="file" accept="image/*" />
        <small class="help">Logo will be scaled to fit a small box in top-right with 10px padding.</small>

        <hr style="margin:12px 0">

        <label>Static bilingual text (editable)</label>
        <textarea id="staticText" rows="6" style="width:100%"></textarea>
        <hr style="margin:12px 0">
        <label>Style & Layout</label>
        <div class="cols-list" style="max-height:unset">
          <div style="display:grid;grid-template-columns:repeat(3, 1fr);gap:8px">
            <div>
              <label>Padding (px)</label>
              <input id="padPx" type="number" min="0" max="48" step="1" />
            </div>
            <div>
              <label>Logo box (px)</label>
              <input id="logoBoxPx" type="number" min="16" max="160" step="2" />
            </div>
            <div>
              <label>Logo top (px)</label>
              <input id="logoTopPx" type="number" min="0" max="120" step="1" />
            </div>
            <div>
              <label>Logo right (px)</label>
              <input id="logoRightPx" type="number" min="0" max="120" step="1" />
            </div>
            <div>
              <label>Line 1 size (px)</label>
              <input id="line1Px" type="number" min="8" max="28" step="1" />
            </div>
            <div>
              <label>Line 2 size (px)</label>
              <input id="line2Px" type="number" min="8" max="24" step="1" />
            </div>
            <div>
              <label>Info text size (px)</label>
              <input id="infoPx" type="number" min="8" max="20" step="1" />
            </div>
            <div>
              <label>Dynamic text size (px)</label>
              <input id="dynPx" type="number" min="8" max="22" step="1" />
            </div>
            <div>
              <label>Barcode height (px)</label>
              <input id="bcHeightPx" type="number" min="20" max="120" step="2" />
            </div>
            <div>
              <label>Barcode font (px)</label>
              <input id="bcFontPx" type="number" min="8" max="24" step="1" />
            </div>
          </div>
        </div>

        <div style="margin-top:10px;display:flex;gap:8px">
          <button id="renderBtn">Render Preview</button>
          <button id="generatePdf" style="background:#059669">Generate A4 PDF</button>
          <a id="downloadPdfLink" href="#" download="labels_a4.pdf" style="display:none;background:#10b981;color:#fff;padding:8px 10px;border-radius:8px;text-decoration:none">Download last PDF</a>
        </div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px">Preview & Controls</h3>

        <!-- Single-label DOM used for html2canvas rendering; will be rendered at high DPI -->
        <div id="labelRenderWrapper" style="display:flex;flex-direction:column;gap:8px">
          <div id="labelCanvasDOM" class="label-preview" style="width:300px">
            <div id="labelInner" style="position:relative;padding:10px;box-sizing:border-box;min-height:130px">
              <div id="logoContainer" class="logo-box" style="position:absolute;right:10px;top:10px;width:60px;height:60px;display:flex;align-items:center;justify-content:center;border-radius:4px;overflow:hidden">
                <span style="color:#999;font-size:12px">logo</span>
              </div>

              <div id="labelContent" style="padding-right:80px">
                <div id="staticLine1" contenteditable="true" style="font-weight:700;direction:rtl">مستورد ومُسوّق بواسطة: شركة أدفيستا للتسويق المحدودة | advistaltd.com</div>
                <div id="staticLine2" contenteditable="true" style="font-size:12px">Imported and Marketed By: Advista Marketing Pvt Ltd | advistaltd.com</div>
                <div id="dynamicPairs" style="margin-top:8px"></div>
                <div id="barcodeArea" style="margin-top:8px"></div>
                <div style="margin-top:8px;font-size:12px">
                  <div id="staticLine3" contenteditable="true">info@advistaltd.com | بنغالور، الهند</div>
                  <div id="staticLine4" contenteditable="true">info@advistaltd.com | Bangalore, India</div>
                </div>
              </div>
            </div>
          </div>

          <div>
            <div class="small-muted">Selected mapping (header: value):</div>
            <div id="mappingPreview" style="margin-top:8px"></div>
          </div>
        </div>

      </div>
    </div>

    <p style="margin-top:12px;font-size:13px;color:#666">Notes: Barcode values are validated for EAN-13 (only digits, 12 or 13 chars). PDF generation creates an A4 PDF (210×297 mm), placing labels in a grid using chosen label size, page margins and spacing. All done locally.</p>
  </div>

<script>
/* ---------- Utilities ---------- */
const mmToPt = mm => (mm * 72 / 25.4); // not used but handy
const mmToPx = (mm, dpi=300) => Math.round(mm * dpi / 25.4); // convert mm to px at a DPI (for high-res canvas)

/* ---------- Defaults & state ---------- */
const presetStatic = `
مستورد ومُسوّق بواسطة: شركة أدفيستا للتسويق المحدودة | advistaltd.com
Imported and Marketed By: Advista Marketing Pvt Ltd | advistaltd.com

info@advistaltd.com | بنغالور، الهند
info@advistaltd.com | Bangalore, India

رقم ضريبة القيمة المضافة (VAT): 313061260900003

تركيبة الخامة: نايلون + سباندكس
Material Composition: Nylon + Spandex
`.trim();

document.getElementById('staticText').value = presetStatic;

let parsedData = []; // array of objects
let headers = [];
let currentLogoDataUrl = null;
let labelSizeMM = {w:80, h:60}; // default medium
let labelDPI = 300; // canvas DPI for export (high quality)
const A4 = {w:210, h:297}; // mm
let pageMarginMM = 6; // page margin in mm (reduced to waste less space)
let labelSpacingMM = 2; // spacing between labels (reduced)

/* DOM refs */
const fileInput = document.getElementById('fileInput');
const gsUrl = document.getElementById('gsUrl');
const loadGsBtn = document.getElementById('loadGs');
const clearFileBtn = document.getElementById('clearFile');
const rowSelect = document.getElementById('rowSelect');
const barcodeSelect = document.getElementById('barcodeSelect');
const barcodeNotice = document.getElementById('barcodeNotice');
const colsList = document.getElementById('colsList');
const mappingPreview = document.getElementById('mappingPreview');
const quantitySelect = document.getElementById('quantitySelect');
const sizeButtons = document.getElementById('sizeButtons');
const logoInput = document.getElementById('logoInput');
const labelCanvasDOM = document.getElementById('labelCanvasDOM');
const logoContainer = document.getElementById('logoContainer');
const labelInner = document.getElementById('labelInner');
const downloadPdfLink = document.getElementById('downloadPdfLink');

// UI inputs for sizing/layout
const labelWmmInput = document.getElementById('labelWmm');
const labelHmmInput = document.getElementById('labelHmm');
const pageMarginInput = document.getElementById('pageMarginInput');
const labelSpacingInput = document.getElementById('labelSpacingInput');
const padPxInput = document.getElementById('padPx');
const logoBoxPxInput = document.getElementById('logoBoxPx');
const logoTopPxInput = document.getElementById('logoTopPx');
const logoRightPxInput = document.getElementById('logoRightPx');
const line1PxInput = document.getElementById('line1Px');
const line2PxInput = document.getElementById('line2Px');
const infoPxInput = document.getElementById('infoPx');
const dynPxInput = document.getElementById('dynPx');
const bcHeightPxInput = document.getElementById('bcHeightPx');
const bcFontPxInput = document.getElementById('bcFontPx');
const renderBtn = document.getElementById('renderBtn');
const generatePdfBtn = document.getElementById('generatePdf');
const dynamicPairsEl = document.getElementById('dynamicPairs');
const barcodeArea = document.getElementById('barcodeArea');
const mappingPreviewBox = document.getElementById('mappingPreview');
const staticTextArea = document.getElementById('staticText');

/* ---------- File parse (Excel/CSV) ---------- */
fileInput.addEventListener('change', async (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  const name = f.name.toLowerCase();
  if(name.endsWith('.csv')){
    const text = await f.text();
    parseCSV(text);
  } else {
    const data = await f.arrayBuffer();
    const wb = XLSX.read(data, {type:'array'});
    const first = wb.Sheets[wb.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(first,{defval:''});
    loadParsed(json);
  }
});

loadGsBtn.addEventListener('click', async ()=>{
  const url = gsUrl.value.trim();
  if(!url){ alert('Paste Google Sheets CSV export URL first.'); return; }
  try{
    const res = await fetch(url);
    if(!res.ok) throw new Error('Fetch failed: ' + res.status);
    const text = await res.text();
    parseCSV(text);
  }catch(err){
    alert('Failed to fetch Google Sheets CSV. Ensure sheet is published or accessible as CSV.\n' + err.message);
  }
});

clearFileBtn.addEventListener('click', ()=>{
  parsedData = []; headers = [];
  rowSelect.innerHTML = '<option value="">(no file)</option>';
  barcodeSelect.innerHTML = '<option value="">(choose column)</option>';
  colsList.innerHTML = '';
  quantitySelect.innerHTML = '<option value="">(none)</option>';
  mappingPreviewBox.innerHTML = '';
  fileInput.value = '';
  gsUrl.value = '';
});

/* robust CSV parse via SheetJS */
function parseCSV(text){
  try{
    const wb = XLSX.read(text, {type:'string'});
    const first = wb.Sheets[wb.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(first, {defval:''});
    loadParsed(json);
  }catch(e){
    alert('CSV parse error: ' + e.message);
  }
}

function loadParsed(json){
  parsedData = json;
  if(parsedData.length === 0){
    alert('File parsed but no rows found.');
    return;
  }
  headers = Object.keys(parsedData[0]);
  // populate row selector
  rowSelect.innerHTML = '';
  parsedData.forEach((r,i)=> {
    const opt = document.createElement('option'); opt.value = i;
    opt.textContent = `Row ${i+1} — ${headers.map(h=>String(r[h]).slice(0,10)).slice(0,3).join(' | ')}`;
    rowSelect.appendChild(opt);
  });
  // barcode & quantity selects
  barcodeSelect.innerHTML = '<option value="">(choose column)</option>';
  quantitySelect.innerHTML = '<option value="">(none)</option>';
  headers.forEach(h=>{
    const opt = document.createElement('option'); opt.value = h; opt.textContent = h;
    barcodeSelect.appendChild(opt);
    const qopt = opt.cloneNode(true);
    quantitySelect.appendChild(qopt);
  });
  // columns list
  renderColumnsCheckboxes();
  // auto-select first row for preview
  rowSelect.value = 0;
  updatePreviewFromRow(0);
}

/* render columns checkboxes */
function renderColumnsCheckboxes(){
  colsList.innerHTML = '';
  headers.forEach(h=>{
    const wrapper = document.createElement('div');
    wrapper.style.display='flex'; wrapper.style.justifyContent='space-between'; wrapper.style.alignItems='center'; wrapper.style.marginBottom='6px';
    const left = document.createElement('div');
    left.innerHTML = `<label style="font-weight:600">${h}</label><div style="font-size:12px;color:#666">will render as: <strong>${h}: [value]</strong></div>`;
    const cb = document.createElement('input'); cb.type='checkbox'; cb.dataset.col = h;
    cb.addEventListener('change', renderMappingPreview);
    wrapper.appendChild(left); wrapper.appendChild(cb);
    colsList.appendChild(wrapper);
  });
}

/* update preview when row changes */
rowSelect.addEventListener('change', (e)=>{
  const idx = e.target.value;
  if(idx==='') return;
  updatePreviewFromRow(parseInt(idx,10));
});

function updatePreviewFromRow(index){
  if(!parsedData[index]) return;
  const row = parsedData[index];
  // barcode notice
  const chosenBarcode = barcodeSelect.value;
  if(chosenBarcode){
    const bc = String(row[chosenBarcode] ?? '');
    barcodeNotice.style.display = 'block';
    barcodeNotice.innerHTML = `<strong>Check barcode value:</strong> <span style="font-weight:700">${bc}</span><br><small>EAN-13 requires 12 or 13 numeric digits — non-digits will be stripped.</small>`;
  } else {
    barcodeNotice.style.display = 'none';
  }
  renderMappingPreview();
}

/* barcode select change */
barcodeSelect.addEventListener('change', ()=>{
  const idx = rowSelect.value;
  if(idx === '') return;
  updatePreviewFromRow(parseInt(idx,10));
});

/* logo upload */
logoInput.addEventListener('change', (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = (ev)=>{
    currentLogoDataUrl = ev.target.result;
    // show small in preview
    logoContainer.innerHTML = '';
    const img = document.createElement('img');
    img.src = currentLogoDataUrl;
    img.style.maxWidth = '100%';
    img.style.maxHeight = '100%';
    img.style.display = 'block';
    logoContainer.appendChild(img);
    // enforce small size (will be scaled in render)
  };
  reader.readAsDataURL(f);
});

/* mapping preview & dynamic pairs */
function renderMappingPreview(){
  mappingPreviewBox.innerHTML = '';
  dynamicPairsEl.innerHTML = '';
  const selected = Array.from(colsList.querySelectorAll('input[type=checkbox]:checked')).map(cb=>cb.dataset.col);
  const idx = rowSelect.value;
  if(idx==='' || !parsedData[idx]) return;
  const row = parsedData[idx];
  selected.forEach(col=>{
    const p = document.createElement('div'); p.className='pair'; p.textContent = `${col}: ${row[col] ?? ''}`;
    mappingPreviewBox.appendChild(p);
    // also add into label dynamicPairsEl
    const d = document.createElement('div'); d.style.marginBottom='6px'; d.innerHTML = `<strong>${col}:</strong> <span>${row[col] ?? ''}</span>`;
    dynamicPairsEl.appendChild(d);
  });
  // static lines mapping
  const staticLines = staticTextArea.value.split('\n').map(s=>s.trim()).filter(Boolean);
  if(staticLines.length>=1) document.getElementById('staticLine1').textContent = staticLines[0];
  if(staticLines.length>=2) document.getElementById('staticLine2').textContent = staticLines[1];
  if(staticLines.length>=3) document.getElementById('staticLine3').textContent = staticLines[2];
  if(staticLines.length>=4) document.getElementById('staticLine4').textContent = staticLines[3];

  // barcode rendering for preview
  renderBarcodePreview();
}

/* render barcode preview using JsBarcode into svg/canvas */
function renderBarcodePreview(){
  barcodeArea.innerHTML = '';
  const idx = rowSelect.value;
  if(idx==='' || !parsedData[idx]) return;
  const row = parsedData[idx];
  const col = barcodeSelect.value;
  if(!col) return;
  let val = String(row[col] ?? '');
  // strip non-digits
  val = val.replace(/\D/g,'');
  if(val.length < 12){
    const msg = document.createElement('div'); msg.style.color='#b02a37'; msg.textContent = 'EAN-13 needs 12 (auto-checksum) or 13 digits. Value has ' + val.length + ' digits after stripping non-digits.';
    barcodeArea.appendChild(msg);
    return;
  }
  // create canvas for JsBarcode
  const canvas = document.createElement('canvas');
  try {
    const h = getIntValue(bcHeightPxInput, 40);
    const f = getIntValue(bcFontPxInput, 12);
    JsBarcode(canvas, val, {format:'ean13', displayValue:true, fontSize:f, height:h, margin:4});
    barcodeArea.appendChild(canvas);
  } catch(err){
    const msg = document.createElement('div'); msg.style.color='#b02a37'; msg.textContent = 'Barcode render error: ' + err.message;
    barcodeArea.appendChild(msg);
  }
}

/* size buttons */
sizeButtons.addEventListener('click', (e)=>{
  if(!e.target.dataset || !e.target.dataset.size) return;
  const size = e.target.dataset.size;
  Array.from(sizeButtons.querySelectorAll('button')).forEach(b=>b.classList.remove('active'));
  e.target.classList.add('active');
  if(size==='small') labelSizeMM = {w:60, h:40};
  else if(size==='medium') labelSizeMM = {w:80, h:60};
  else labelSizeMM = {w:100, h:80};
  // update preview width approx
  const pxW = Math.round(labelSizeMM.w * 3.78); // ~96dpi just for UI
  labelCanvasDOM.style.width = pxW + 'px';
});

/* render preview button */
renderBtn.addEventListener('click', ()=>{
  renderMappingPreview();
  alert('Preview rendered on right. If barcode value is not valid for EAN-13 check the barcode column or data.');
});

/* ---------- PDF generation ---------- */
generatePdfBtn.addEventListener('click', async ()=>{
  if(!parsedData || parsedData.length===0){ alert('Load a sheet first'); return; }
  // Build list of label rows to generate (respect quantity column)
  const qtyCol = quantitySelect.value;
  const chosenBarcodeCol = barcodeSelect.value;
  const selectedCols = Array.from(colsList.querySelectorAll('input[type=checkbox]:checked')).map(cb=>cb.dataset.col);
  if(!chosenBarcodeCol){ if(!confirm('No barcode column selected. Continue without barcode?')) return; }

  // Build flat array of items (each item corresponds to one label instance)
  const items = [];
  parsedData.forEach((row, rowIndex)=>{
    let qty = 1;
    if(qtyCol){
      const raw = String(row[qtyCol] ?? '').trim();
      const n = parseInt(raw,10);
      qty = Number.isFinite(n) && n>0 ? n : 1;
    }
    for(let i=0;i<qty;i++){
      items.push({rowIndex, row});
    }
  });

  if(items.length === 0){ alert('No labels to generate (0 items).'); return; }
  // For performance/preview ask user? but requirement forbids wait — proceed.

  // Calculate grid layout for A4
  const usableW = A4.w - 2*pageMarginMM;
  const usableH = A4.h - 2*pageMarginMM;
  const cols = Math.floor( (usableW + labelSpacingMM) / (labelSizeMM.w + labelSpacingMM) );
  const rows = Math.floor( (usableH + labelSpacingMM) / (labelSizeMM.h + labelSpacingMM) );
  if(cols < 1 || rows < 1){ alert('Label size too large to fit on A4 with current margins. Choose a smaller label size or reduce margins.'); return; }
  const perPage = cols * rows;

  // Show quick information
  const pagesNeeded = Math.ceil(items.length / perPage);
  if(!confirm(`Generating ${items.length} labels → ${pagesNeeded} A4 page(s).\nLabels per page: ${perPage} (${cols}×${rows}). Proceed?`)) return;

  // Function to render one label DOM instance into a dataURL at print DPI
  async function renderLabelToDataUrl(row){
    // Build a temporary DOM clone of labelCanvasDOM with actual mm->px size at labelDPI
    const pxW = mmToPx(labelSizeMM.w, labelDPI);
    const pxH = mmToPx(labelSizeMM.h, labelDPI);

    // Create a wrapper element offscreen
    const wrapper = document.createElement('div');
    wrapper.style.width = pxW + 'px';
    wrapper.style.height = pxH + 'px';
    wrapper.style.boxSizing = 'border-box';
    wrapper.style.padding = '0';
    wrapper.style.background = '#ffffff';
    wrapper.style.position = 'fixed';
    wrapper.style.left = '-99999px';
    wrapper.style.top = '-99999px';
    document.body.appendChild(wrapper);

    // Compose inner HTML (simple, clean layout scaled for high DPI)
    const staticLines = staticTextArea.value.split('\n').map(s=>s.trim()).filter(Boolean);
    const line1 = staticLines[0] || '';
    const line2 = staticLines[1] || '';
    const line3 = staticLines[2] || '';
    const line4 = staticLines[3] || '';

    // Build content
    const padPx = getIntValue(padPxInput, 12);
    const logoBoxPx = getIntValue(logoBoxPxInput, 60);
    const logoTopPx = getIntValue(logoTopPxInput, 10);
    const logoRightPx = getIntValue(logoRightPxInput, 10);
    const line1Px = getIntValue(line1PxInput, 14);
    const line2Px = getIntValue(line2PxInput, 12);
    const infoPx = getIntValue(infoPxInput, 11);
    const dynPx = getIntValue(dynPxInput, 12);
    const bcHeightPx = getIntValue(bcHeightPxInput, 40);
    const bcFontPx = getIntValue(bcFontPxInput, 12);

    wrapper.innerHTML = `
      <div style="width:100%;height:100%;padding:${padPx}px;box-sizing:border-box;font-family:Arial,Helvetica,sans-serif;color:#111;">
        <div style="position:relative;height:100%;">
          <div style="position:absolute;right:${logoRightPx}px;top:${logoTopPx}px;width:${logoBoxPx}px;height:${logoBoxPx}px;overflow:hidden;display:flex;align-items:center;justify-content:center;">
            ${ currentLogoDataUrl ? `<img src="${currentLogoDataUrl}" style="max-width:100%;max-height:100%;display:block" />` : `<div style=\"color:#888;font-size:${12}px\">logo</div>` }
          </div>

          <div style="padding-right:${logoBoxPx + 6}px">
            <div style="font-weight:700;font-size:${line1Px}px;direction:rtl">${escapeHtml(line1)}</div>
            <div style="font-size:${line2Px}px;margin-top:4px">${escapeHtml(line2)}</div>

            <div id="dynContent" style="margin-top:8px;font-size:${dynPx}px;line-height:1.1">
              ${selectedCols.map(col => `<div><strong>${escapeHtml(col)}:</strong> ${escapeHtml(String(row[col] ?? ''))}</div>`).join('')}
            </div>

            <div id="barcodeHolder" style="margin-top:8px"></div>

            <div style="position:absolute;bottom:${padPx}px;left:${padPx}px;right:${padPx}px;font-size:${infoPx}px">
              <div>${escapeHtml(line3)}</div>
              <div style="font-size:${infoPx}px">${escapeHtml(line4)}</div>
            </div>
          </div>
        </div>
      </div>
    `;

    // Insert barcode canvas using JsBarcode into barcodeHolder
    if(chosenBarcodeCol){
      const raw = String(row[chosenBarcodeCol] ?? '').replace(/\D/g,'');
      const bcVal = raw;
      const barDiv = document.createElement('div');
      wrapper.querySelector('#barcodeHolder').appendChild(barDiv);
      const bCan = document.createElement('canvas');
      // size settings tailored for label size
      try {
        JsBarcode(bCan, bcVal, {format:'ean13', width:2, height:bcHeightPx, displayValue:true, fontSize:bcFontPx, margin:4});
        barDiv.appendChild(bCan);
      } catch(e){
        // on error, show error text
        const errDiv = document.createElement('div'); errDiv.style.color='#b02a37'; errDiv.textContent = 'Invalid EAN-13: ' + e.message;
        barDiv.appendChild(errDiv);
      }
    }

    // Now use html2canvas at scale = labelDPI / 96 approx.
    const scale = labelDPI / 96;
    const canvas = await html2canvas(wrapper, {width:pxW, height:pxH, scale:scale, backgroundColor:'#ffffff', useCORS:true});
    const dataUrl = canvas.toDataURL('image/png', 1.0);
    // cleanup
    wrapper.remove();
    return {dataUrl, pxW, pxH};
  } // end renderLabelToDataUrl

  // Pre-render all labels sequentially (could be optimized in batches)
  const rendered = [];
  for(let i=0;i<items.length;i++){
    const it = items[i];
    // show progress in title
    if(i % 5 === 0) document.title = `Rendering ${i+1}/${items.length}...`;
    const r = await renderLabelToDataUrl(it.row);
    rendered.push(r);
  }
  document.title = 'Label Maker';

  // Compose pages using jsPDF
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({unit:'mm', format:'a4', compress:true});

  // compute positions
  const colsPerPage = cols;
  const rowsPerPage = rows;
  const spacing = labelSpacingMM;
  const startX = pageMarginMM;
  const startY = pageMarginMM;

  let pageIndex = 0;
  let labelIndex = 0;

  while(labelIndex < rendered.length){
    if(pageIndex > 0) pdf.addPage();
    // for each row & col on page:
    for(let r=0;r<rowsPerPage;r++){
      for(let c=0;c<colsPerPage;c++){
        const globalIndex = pageIndex*perPage + r*colsPerPage + c;
        if(globalIndex >= rendered.length) break;
        const itemRendered = rendered[globalIndex];
        // compute x,y in mm
        const x = startX + c*(labelSizeMM.w + spacing);
        const y = startY + r*(labelSizeMM.h + spacing);
        // add image: convert dataUrl to jsPDF image, specify width/height in mm
        try{
          pdf.addImage(itemRendered.dataUrl, 'PNG', x, y, labelSizeMM.w, labelSizeMM.h);
        }catch(e){
          console.error('addImage error', e);
          pdf.text('Image add error', x+5, y+10);
        }
        labelIndex++;
      }
      if(labelIndex >= rendered.length) break;
    }
    pageIndex++;
  }

  // finalize: download and expose link
  try{
    const blob = pdf.output('blob');
    const url = URL.createObjectURL(blob);
    downloadPdfLink.href = url;
    downloadPdfLink.style.display = 'inline-block';
  }catch(e){
    console.warn('Could not create blob URL for download link', e);
  }
  pdf.save('labels_a4.pdf');
  alert('PDF generated and downloaded. Pages: ' + pageIndex);
});

/* ---------- Helpers ---------- */
function escapeHtml(s){
  if(!s) return '';
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}
function mmToPxRounded(mm, dpi=300){ return Math.round(mm * dpi / 25.4); }

/* Keep preview synced when quantity column selection or checkboxes change */
quantitySelect.addEventListener('change', ()=>{/* nothing for preview */});
colsList.addEventListener('change', ()=>{/* delegated via checkboxes */});

/* Auto heuristics for common column names */
function autoSelectHeuristics(){
  if(!headers || headers.length===0) return;
  const low = headers.map(h=>h.toLowerCase());
  const picks = [];
  ['barcode','sku','ean','upc','code'].forEach(k=>{
    const idx = low.findIndex(h=>h.includes(k));
    if(idx>=0) picks.push(headers[idx]);
  });
  ['name','title','description'].forEach(k=>{
    const idx = low.findIndex(h=>h.includes(k));
    if(idx>=0) picks.push(headers[idx]);
  });
  // mark checkboxes
  Array.from(colsList.querySelectorAll('input[type=checkbox]')).forEach(cb=>{
    if(picks.includes(cb.dataset.col)) cb.checked = true;
  });
}
const obs = new MutationObserver(()=> autoSelectHeuristics());
obs.observe(colsList, {childList:true, subtree:true});

/* initial UI sizing */
labelCanvasDOM.style.width = '300px';
labelCanvasDOM.style.minHeight = '180px';

/* when barcode col or row changes, rerender preview */
rowSelect.addEventListener('change', renderMappingPreview);
barcodeSelect.addEventListener('change', renderMappingPreview);

/* ---------- New: style controls binding ---------- */
function getIntValue(inputEl, fallback){
  const n = parseInt(String(inputEl && inputEl.value || '').trim(), 10);
  return Number.isFinite(n) ? n : fallback;
}

function applyStyleControlsToPreview(){
  const padPx = getIntValue(padPxInput, 12);
  const logoBoxPx = getIntValue(logoBoxPxInput, 60);
  const logoTopPx = getIntValue(logoTopPxInput, 10);
  const logoRightPx = getIntValue(logoRightPxInput, 10);
  const line1Px = getIntValue(line1PxInput, 14);
  const line2Px = getIntValue(line2PxInput, 12);
  const infoPx = getIntValue(infoPxInput, 11);
  const dynPx = getIntValue(dynPxInput, 12);

  if(labelInner) labelInner.style.padding = padPx + 'px';
  if(logoContainer){
    logoContainer.style.top = logoTopPx + 'px';
    logoContainer.style.right = logoRightPx + 'px';
    logoContainer.style.width = logoBoxPx + 'px';
    logoContainer.style.height = logoBoxPx + 'px';
  }
  const labelContentEl = document.getElementById('labelContent');
  if(labelContentEl) labelContentEl.style.paddingRight = (getIntValue(logoBoxPxInput, 60) + 6) + 'px';
  const staticLine1El = document.getElementById('staticLine1');
  const staticLine2El = document.getElementById('staticLine2');
  if(staticLine1El) staticLine1El.style.fontSize = line1Px + 'px';
  if(staticLine2El) staticLine2El.style.fontSize = line2Px + 'px';
  const dynEl = document.getElementById('dynamicPairs');
  if(dynEl) dynEl.style.fontSize = dynPx + 'px';
  // bottom info container font size set via inline style container; re-apply with mapping preview
  renderBarcodePreview();
}

// initialize inputs with defaults and bind events
labelWmmInput.value = String(labelSizeMM.w);
labelHmmInput.value = String(labelSizeMM.h);
pageMarginInput.value = String(pageMarginMM);
labelSpacingInput.value = String(labelSpacingMM);
padPxInput.value = '12';
logoBoxPxInput.value = '60';
logoTopPxInput.value = '10';
logoRightPxInput.value = '10';
line1PxInput.value = '14';
line2PxInput.value = '12';
infoPxInput.value = '11';
dynPxInput.value = '12';
bcHeightPxInput.value = '40';
bcFontPxInput.value = '12';
applyStyleControlsToPreview();

labelWmmInput.addEventListener('change', ()=>{
  const w = getIntValue(labelWmmInput, labelSizeMM.w);
  labelSizeMM.w = Math.max(20, Math.min(200, w));
  const pxW = Math.round(labelSizeMM.w * 3.78);
  labelCanvasDOM.style.width = pxW + 'px';
});
labelHmmInput.addEventListener('change', ()=>{
  const h = getIntValue(labelHmmInput, labelSizeMM.h);
  labelSizeMM.h = Math.max(20, Math.min(200, h));
});
pageMarginInput.addEventListener('change', ()=>{
  pageMarginMM = Math.max(0, Math.min(25, getIntValue(pageMarginInput, pageMarginMM)));
});
labelSpacingInput.addEventListener('change', ()=>{
  labelSpacingMM = Math.max(0, Math.min(10, getIntValue(labelSpacingInput, labelSpacingMM)));
});
[padPxInput, logoBoxPxInput, logoTopPxInput, logoRightPxInput, line1PxInput, line2PxInput, infoPxInput, dynPxInput, bcHeightPxInput, bcFontPxInput].forEach(el=>{
  el.addEventListener('change', applyStyleControlsToPreview);
  el.addEventListener('input', applyStyleControlsToPreview);
});

// Sync contenteditable static lines with textarea and preview
['staticLine1','staticLine2','staticLine3','staticLine4'].forEach(id=>{
  const el = document.getElementById(id);
  if(!el) return;
  el.addEventListener('input', ()=>{
    const lines = ['staticLine1','staticLine2','staticLine3','staticLine4'].map(k=>{
      const n = document.getElementById(k);
      return n ? n.textContent.trim() : '';
    });
    staticTextArea.value = lines.filter(Boolean).join('\n');
    renderMappingPreview();
  });
});
staticTextArea.addEventListener('input', ()=>{
  renderMappingPreview();
});

</script>
</body>
</html>
